<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Management - Fleet Management System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/static/modern_theme.css">
  <link rel="stylesheet" href="/static/responsive_tables.css">
  <link rel="stylesheet" href="/static/help_system.css">
  <link rel="stylesheet" href="/static/enhanced_help_system.css">
  <link rel="stylesheet" href="/static/autocomplete.css">
  <style nonce="{{.CSPNonce}}">
    /* Students page with purple theme */
    .students-header {
      color: white !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      margin-bottom: 2rem;
    }
    
    .students-header i {
      color: white !important;
    }
    
    /* Student cards with gradient accents */
    .student-card {
      position: relative;
      height: 100%;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }
    
    .student-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .student-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    /* Student avatar with gradient */
    .student-avatar {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: var(--color-text-inverse);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-right: var(--space-md);
    }
    
    /* Student status badges with gradients */
    .student-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.875rem;
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .student-status.active {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 2px 8px rgba(17, 153, 142, 0.3);
    }
    
    .student-status.inactive {
      background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
    }
    
    .location-badge {
      display: inline-block;
      padding: var(--space-xs) var(--space-sm);
      margin: var(--space-xs) var(--space-xs) var(--space-xs) 0;
      border-radius: var(--border-radius-base);
      font-size: var(--font-size-small);
      background: var(--color-bg-tertiary);
      color: var(--color-text-primary);
    }
    
    .location-badge.pickup {
      background: var(--color-info-light);
      color: var(--color-info-dark);
    }
    
    .location-badge.dropoff {
      background: var(--color-warning-light);
      color: var(--color-warning-dark);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    
    .stat-card {
      background: var(--color-bg-primary);
      padding: var(--space-lg);
      border-radius: var(--border-radius-lg);
      text-align: center;
      box-shadow: var(--shadow-sm);
    }
    
    .stat-number {
      font-size: var(--font-size-xxl);
      font-weight: 700;
      color: var(--color-primary);
      display: block;
      margin-bottom: var(--space-sm);
    }
    
    .stat-label {
      font-size: var(--font-size-base);
      color: var(--color-text-secondary);
    }
    
    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: var(--space-lg);
    }
    
    .student-info {
      display: flex;
      align-items: center;
      margin-bottom: var(--space-md);
    }
    
    .student-details h3 {
      font-size: var(--font-size-large);
      margin-bottom: var(--space-xs);
    }
    
    .student-schedule {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
      margin-bottom: var(--space-md);
    }
    
    .schedule-badge {
      background: var(--color-bg-tertiary);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--border-radius-base);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .info-row {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
      color: var(--color-text-secondary);
    }
    
    .info-row i {
      color: var(--color-primary);
      width: 20px;
    }
  </style>
</head>
<body>
  <div class="container-fluid page-container">
    <!-- Navigation Component -->
    {{template "navigation" (dict "Navigation" .Navigation "CSPNonce" .CSPNonce "ShowHelpButton" .ShowHelpButton "PageDescription" "Manage student information and assignments")}}
    
    <!-- Header -->
    <header class="page-header">
      <div class="page-header-content">
        <div class="page-header-text">
          <h1>
            <i class="bi bi-people-fill" aria-hidden="true"></i>
            Student Management
          </h1>
          <p class="page-description">Manage student roster and transportation details</p>
        </div>
        <nav class="page-header-nav">
          <a href="/add-student-wizard" class="btn btn-primary" data-help="add-student" data-help-title="Add New Student" data-help-content="Click here to start the step-by-step wizard for adding a new student to your roster. The wizard will guide you through entering basic information, contact details, pickup/dropoff locations, and route assignment.">
            <i class="bi bi-person-plus" aria-hidden="true"></i>
            Add Student
          </a>
        </nav>
      </div>
    </header>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
      <!-- Student Statistics -->
      <section aria-labelledby="stats-heading">
        <h2 id="stats-heading" class="sr-only">Student Statistics</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-number" id="totalStudents">{{len .Data.Students}}</span>
            <div class="stat-label">Total Students</div>
          </div>
          <div class="stat-card">
            <span class="stat-number" id="activeStudents">0</span>
            <div class="stat-label">Active Students</div>
          </div>
          <div class="stat-card">
            <span class="stat-number" id="morningPickups">0</span>
            <div class="stat-label">Morning Pickups</div>
          </div>
          <div class="stat-card">
            <span class="stat-number" id="afternoonDropoffs">0</span>
            <div class="stat-label">Afternoon Dropoffs</div>
          </div>
        </div>
      </section>
      
      <!-- Students List -->
      <section aria-labelledby="students-heading">
        <h2 id="students-heading">All Students</h2>
        
        {{if .Data.Students}}
        <div class="student-grid">
          {{range .Data.Students}}
          <div class="card student-card">
            <div class="card-header">
              <div class="student-info">
                <div class="student-avatar">
                  <i class="bi bi-person" aria-hidden="true"></i>
                </div>
                <div class="student-details">
                  <h3>{{.Name}}</h3>
                  <span class="student-status {{if .Active}}active{{else}}inactive{{end}}">
                    {{if .Active}}
                      <i class="bi bi-check-circle" aria-hidden="true"></i> Active
                    {{else}}
                      <i class="bi bi-x-circle" aria-hidden="true"></i> Inactive
                    {{end}}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="card-body">
              <!-- Schedule -->
              <div class="student-schedule">
                <div class="schedule-badge">
                  <i class="bi bi-sunrise" aria-hidden="true"></i>
                  Pickup: {{if .PickupTime}}{{.PickupTime}}{{else}}Not Set{{end}}
                </div>
                <div class="schedule-badge">
                  <i class="bi bi-sunset" aria-hidden="true"></i>
                  Dropoff: {{if .DropoffTime}}{{.DropoffTime}}{{else}}Not Set{{end}}
                </div>
              </div>
              
              <!-- Contact Information -->
              <div class="info-row">
                <i class="bi bi-person-heart" aria-hidden="true"></i>
                <span>Guardian: {{.Guardian}}</span>
              </div>
              <div class="info-row">
                <i class="bi bi-telephone" aria-hidden="true"></i>
                <span>{{.PhoneNumber}}</span>
              </div>
              {{if .AltPhoneNumber}}
              <div class="info-row">
                <i class="bi bi-telephone-plus" aria-hidden="true"></i>
                <span>{{.AltPhoneNumber}}</span>
              </div>
              {{end}}
              
              <!-- Locations -->
              {{if .Locations}}
              <div class="locations-section">
                <h4 class="small text-muted mb-2">Locations:</h4>
                {{range .Locations}}
                <span class="location-badge {{.Type}}">
                  <i class="bi bi-geo-alt" aria-hidden="true"></i>
                  {{.Type}}: {{.Address}}
                </span>
                {{end}}
              </div>
              {{end}}
              
              <!-- Actions -->
              <div class="card-actions">
                <button type="button" class="btn btn-sm btn-outline-primary edit-student-btn" data-help="edit-student" data-help-title="Edit Student" data-help-content="Update student information including contact details, routes, and pickup/dropoff times. Changes are saved immediately." 
                        data-student-id="{{.StudentID}}" 
                        data-name="{{.Name}}" 
                        data-phone="{{.PhoneNumber}}" 
                        data-alt-phone="{{.AltPhoneNumber}}" 
                        data-guardian="{{.Guardian}}" 
                        data-pickup-time="{{.PickupTime}}" 
                        data-dropoff-time="{{.DropoffTime}}" 
                        data-route-id="{{.RouteID}}" 
                        data-active="{{.Active}}"
                        data-locations='{{.Locations | json}}'
                        aria-label="Edit {{.Name}}">
                  <i class="bi bi-pencil" aria-hidden="true"></i>
                  Edit
                </button>
                <form method="POST" action="/remove-student" class="remove-student-form" style="display: inline;"
                      data-confirm="Are you sure you want to remove {{.Name}}? This action cannot be undone."
                      data-confirm-title="Remove Student">
                  <input type="hidden" name="csrf_token" value="{{$.Data.CSRFToken}}">
                  <input type="hidden" name="student_id" value="{{.StudentID}}">
                  <button type="submit" class="btn btn-sm btn-outline-danger" aria-label="Remove {{.Name}}" data-help="remove-student" data-help-title="Remove Student" data-help-content="Permanently remove this student from the system. You will be asked to confirm this action. This cannot be undone.">
                    <i class="bi bi-trash" aria-hidden="true"></i>
                    Remove
                  </button>
                </form>
              </div>
            </div>
          </div>
          {{end}}
        </div>
        {{else}}
        <div class="empty-state">
          <i class="bi bi-person-plus" aria-hidden="true"></i>
          <h3>No Students Added Yet</h3>
          <p>Get started by adding your first student to the roster</p>
          <a href="/add-student-wizard" class="btn btn-primary">
            <i class="bi bi-person-plus" aria-hidden="true"></i>
            Add First Student
          </a>
        </div>
        {{end}}
      </section>
    </main>
  </div>
  
  <!-- Add Student Modal -->
  <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="addStudentModalLabel">Add New Student</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="POST" action="/add-student" class="accessible-form">
          <input type="hidden" name="csrf_token" value="{{$.Data.CSRFToken}}">
          <div class="modal-body">
            <div class="form-group">
              <label for="name" class="form-label required">Student Name</label>
              <input type="text" id="name" name="name" class="form-control" placeholder="Enter student's full name" required data-help="student-name" data-help-title="Student Name" data-help-content="Enter the student's full name as it appears on school records. This helps drivers identify students correctly.">
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="guardian" class="form-label required">Guardian/Contact Person</label>
                  <input type="text" id="guardian" name="guardian" class="form-control" placeholder="Parent or guardian name" required data-help="guardian-name" data-help-title="Guardian Information" data-help-content="Enter the name of the parent or guardian who should be contacted in case of emergency or schedule changes.">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="route_id" class="form-label required">Route</label>
                  <select id="route_id" name="route_id" class="form-control form-select" required data-help="route-selection" data-help-title="Route Assignment" data-help-content="Select the bus route this student will be assigned to. Routes determine which driver will pick up and drop off the student.">
                    <option value="">Select Route</option>
                    {{range .Data.Routes}}
                    <option value="{{.RouteID}}">{{.RouteName}}</option>
                    {{end}}
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="phone_number" class="form-label required">Phone Number</label>
                  <input type="tel" id="phone_number" name="phone_number" class="form-control" placeholder="123-456-7890" required data-help="phone-number" data-help-title="Primary Phone" data-help-content="Enter the primary contact phone number. This will be used for urgent communications and emergencies.">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="alt_phone_number" class="form-label">Alternate Phone</label>
                  <input type="tel" id="alt_phone_number" name="alt_phone_number" class="form-control" placeholder="123-456-7890">
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="pickup_time" class="form-label">Pickup Time</label>
                  <input type="time" id="pickup_time" name="pickup_time" class="form-control" data-help="pickup-time" data-help-title="Pickup Time" data-help-content="Set the scheduled morning pickup time for this student. This helps drivers plan their routes efficiently.">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="dropoff_time" class="form-label">Dropoff Time</label>
                  <input type="time" id="dropoff_time" name="dropoff_time" class="form-control">
                </div>
              </div>
            </div>
            
            <fieldset>
              <legend>Pickup Locations</legend>
              <div id="pickupLocations">
                <div class="row mb-2">
                  <div class="col-md-6">
                    <input type="text" class="form-control pickup-address" name="pickup_address" placeholder="123 Main Street" data-help="pickup-address" data-help-title="Pickup Location" data-help-content="Enter the complete street address where the student will be picked up. Include house number, street name, and any helpful landmarks.">
                  </div>
                  <div class="col-md-6">
                    <input type="text" class="form-control" name="pickup_description" placeholder="Description (optional)">
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary add-pickup-location">
                <i class="bi bi-plus-circle" aria-hidden="true"></i> Add Another Pickup Location
              </button>
            </fieldset>
            
            <fieldset>
              <legend>Dropoff Locations</legend>
              <div id="dropoffLocations">
                <div class="row mb-2">
                  <div class="col-md-6">
                    <input type="text" class="form-control dropoff-address" name="dropoff_address" placeholder="123 School Street" data-help="dropoff-address" data-help-title="Dropoff Location" data-help-content="Enter the complete street address where the student will be dropped off. This may be different from the pickup address.">
                  </div>
                  <div class="col-md-6">
                    <input type="text" class="form-control" name="dropoff_description" placeholder="Description (optional)">
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary add-dropoff-location">
                <i class="bi bi-plus-circle" aria-hidden="true"></i> Add Another Dropoff Location
              </button>
            </fieldset>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Student</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Edit Student Modal -->
  <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="editStudentModalLabel">Edit Student</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="POST" action="/edit-student" class="accessible-form">
          <input type="hidden" name="csrf_token" value="{{$.Data.CSRFToken}}">
          <input type="hidden" name="student_id" id="edit_student_id">
          <input type="hidden" name="position_number" id="edit_position_number" value="0">
          <div class="modal-body">
            <div class="form-group">
              <label for="edit_name" class="form-label required">Student Name</label>
              <input type="text" id="edit_name" name="name" class="form-control" required>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_guardian" class="form-label required">Guardian/Contact Person</label>
                  <input type="text" id="edit_guardian" name="guardian" class="form-control" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_route_id" class="form-label required">Route</label>
                  <select id="edit_route_id" name="route_id" class="form-control form-select" required>
                    <option value="">Select Route</option>
                    {{range .Data.Routes}}
                    <option value="{{.RouteID}}">{{.RouteName}}</option>
                    {{end}}
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="edit_phone_number" class="form-label required">Phone Number</label>
                  <input type="tel" id="edit_phone_number" name="phone_number" class="form-control" required>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="edit_alt_phone_number" class="form-label">Alt Phone Number</label>
                  <input type="tel" id="edit_alt_phone_number" name="alt_phone_number" class="form-control">
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label for="edit_active" class="form-label">Status</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="edit_active" name="active">
                    <label class="form-check-label" for="edit_active">Active Student</label>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_pickup_time" class="form-label">Pickup Time</label>
                  <input type="time" id="edit_pickup_time" name="pickup_time" class="form-control">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="edit_dropoff_time" class="form-label">Dropoff Time</label>
                  <input type="time" id="edit_dropoff_time" name="dropoff_time" class="form-control">
                </div>
              </div>
            </div>
            
            <fieldset>
              <legend>Pickup Locations</legend>
              <div id="editPickupLocations"></div>
              <button type="button" class="btn btn-sm btn-outline-primary add-edit-pickup-location">
                <i class="bi bi-plus-circle" aria-hidden="true"></i> Add Another Pickup Location
              </button>
            </fieldset>
            
            <fieldset>
              <legend>Dropoff Locations</legend>
              <div id="editDropoffLocations"></div>
              <button type="button" class="btn btn-sm btn-outline-primary add-edit-dropoff-location">
                <i class="bi bi-plus-circle" aria-hidden="true"></i> Add Another Dropoff Location
              </button>
            </fieldset>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Student</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/help_system.js"></script>
  <script src="/static/accessible_forms.js"></script>
  <script src="/static/enhanced_help_system.js"></script>
  <script src="/static/autocomplete.js"></script>
  
  {{template "error_prevention_scripts" .}}
  
  <script nonce="{{.CSPNonce}}">
    document.addEventListener('DOMContentLoaded', function() {
      // Calculate statistics
      {{if .Data.Students}}
      const students = [
        {{range .Data.Students}}
        {active: {{.Active}}, pickupTime: "{{.PickupTime}}", dropoffTime: "{{.DropoffTime}}"},
        {{end}}
      ];
      
      const activeCount = students.filter(s => s.active).length;
      const morningCount = students.filter(s => s.pickupTime && s.pickupTime < "12:00").length;
      const afternoonCount = students.filter(s => s.dropoffTime && s.dropoffTime >= "12:00").length;
      
      document.getElementById('activeStudents').textContent = activeCount;
      document.getElementById('morningPickups').textContent = morningCount;
      document.getElementById('afternoonDropoffs').textContent = afternoonCount;
      {{end}}
      
      // Handle location additions
      document.addEventListener('click', function(e) {
        if (e.target.closest('.add-pickup-location')) {
          addPickupLocation();
        }
        if (e.target.closest('.add-dropoff-location')) {
          addDropoffLocation();
        }
        if (e.target.closest('.add-edit-pickup-location')) {
          addEditPickupLocation();
        }
        if (e.target.closest('.add-edit-dropoff-location')) {
          addEditDropoffLocation();
        }
        if (e.target.closest('.edit-student-btn')) {
          const btn = e.target.closest('.edit-student-btn');
          editStudent(btn.dataset);
        }
      });
      
      // Removed redundant confirmation code - now handled by confirmation_dialogs.js
      
      function addPickupLocation() {
        const container = document.getElementById('pickupLocations');
        const div = document.createElement('div');
        div.className = 'row mb-2';
        div.innerHTML = `
          <div class="col-md-6">
            <input type="text" class="form-control pickup-address" name="pickup_address" placeholder="123 Main Street">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="pickup_description" placeholder="Description (optional)">
          </div>
        `;
        container.appendChild(div);
      }
      
      function addDropoffLocation() {
        const container = document.getElementById('dropoffLocations');
        const div = document.createElement('div');
        div.className = 'row mb-2';
        div.innerHTML = `
          <div class="col-md-6">
            <input type="text" class="form-control dropoff-address" name="dropoff_address" placeholder="123 School Street">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="dropoff_description" placeholder="Description (optional)">
          </div>
        `;
        container.appendChild(div);
      }
      
      function addEditPickupLocation() {
        const container = document.getElementById('editPickupLocations');
        const div = document.createElement('div');
        div.className = 'row mb-2';
        div.innerHTML = `
          <div class="col-md-6">
            <input type="text" class="form-control pickup-address" name="pickup_address" placeholder="123 Main Street">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="pickup_description" placeholder="Description (optional)">
          </div>
        `;
        container.appendChild(div);
      }
      
      function addEditDropoffLocation() {
        const container = document.getElementById('editDropoffLocations');
        const div = document.createElement('div');
        div.className = 'row mb-2';
        div.innerHTML = `
          <div class="col-md-6">
            <input type="text" class="form-control dropoff-address" name="dropoff_address" placeholder="123 School Street">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="dropoff_description" placeholder="Description (optional)">
          </div>
        `;
        container.appendChild(div);
      }
      
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      
      function editStudent(data) {
        // Clear previous locations first
        document.getElementById('editPickupLocations').innerHTML = '';
        document.getElementById('editDropoffLocations').innerHTML = '';
        
        // Populate form fields
        document.getElementById('edit_student_id').value = data.studentId;
        document.getElementById('edit_name').value = data.name;
        document.getElementById('edit_phone_number').value = data.phone;
        document.getElementById('edit_alt_phone_number').value = data.altPhone || '';
        document.getElementById('edit_guardian').value = data.guardian;
        document.getElementById('edit_pickup_time').value = data.pickupTime || '';
        document.getElementById('edit_dropoff_time').value = data.dropoffTime || '';
        document.getElementById('edit_route_id').value = data.routeId;
        document.getElementById('edit_active').checked = data.active === 'true';
        
        // Populate locations
        try {
          const locations = JSON.parse(data.locations || '[]');
          
          locations.forEach(function(location) {
            if (location.Type === 'pickup') {
              const container = document.getElementById('editPickupLocations');
              const div = document.createElement('div');
              div.className = 'row mb-2';
              const address = escapeHtml(location.Address || '');
              const description = escapeHtml(location.Description || '');
              div.innerHTML = `
                <div class="col-md-6">
                  <input type="text" class="form-control pickup-address" name="pickup_address" value="${address}" placeholder="123 Main Street">
                </div>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="pickup_description" value="${description}" placeholder="Description (optional)">
                </div>
              `;
              container.appendChild(div);
            } else if (location.Type === 'dropoff') {
              const container = document.getElementById('editDropoffLocations');
              const div = document.createElement('div');
              div.className = 'row mb-2';
              const address = escapeHtml(location.Address || '');
              const description = escapeHtml(location.Description || '');
              div.innerHTML = `
                <div class="col-md-6">
                  <input type="text" class="form-control dropoff-address" name="dropoff_address" value="${address}" placeholder="123 School Street">
                </div>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="dropoff_description" value="${description}" placeholder="Description (optional)">
                </div>
              `;
              container.appendChild(div);
            }
          });
        } catch (e) {
          console.error('Error processing locations:', e);
        }
        
        // Ensure at least one location input for each type
        if (document.getElementById('editPickupLocations').children.length === 0) {
          addEditPickupLocation();
        }
        if (document.getElementById('editDropoffLocations').children.length === 0) {
          addEditDropoffLocation();
        }
        
        const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
        modal.show();
      }
    });
    
    // Initialize auto-complete and smart fields
    initializeStudentAutoComplete();
  </script>
  
  <script nonce="{{.CSPNonce}}">
    function initializeStudentAutoComplete() {
      // Initialize smart field suggestions for phone numbers
      const smartFields = new SmartFieldSuggestions();
      smartFields.enhance('phone_number', 'phone');
      smartFields.enhance('alt_phone_number', 'phone');
      smartFields.enhance('edit_phone_number', 'phone');
      smartFields.enhance('edit_alt_phone_number', 'phone');
      
      // Initialize smart field suggestions for times
      smartFields.enhance('pickup_time', 'time');
      smartFields.enhance('dropoff_time', 'time');
      
      // Common street suffixes for address auto-complete
      const streetSuffixes = ['Street', 'St', 'Avenue', 'Ave', 'Road', 'Rd', 'Boulevard', 'Blvd', 
                             'Drive', 'Dr', 'Lane', 'Ln', 'Court', 'Ct', 'Circle', 'Cir'];
      
      // Common local addresses (would be fetched from API in production)
      const commonAddresses = [
        '123 Main Street',
        '456 Oak Avenue',
        '789 Elm Drive',
        '321 Pine Road',
        '654 Maple Lane',
        '987 Cedar Court',
        'Washington Elementary School',
        'Lincoln Middle School',
        'Roosevelt High School',
        'Community Center',
        'Public Library',
        'City Park Entrance'
      ];
      
      // Auto-complete for pickup addresses
      document.querySelectorAll('.pickup-address').forEach(input => {
        const inputId = input.id || generateUniqueId();
        if (!input.id) input.id = inputId;
        
        new AutoComplete(inputId, {
          source: function(query) {
            return fetch(`/api/search-addresses?q=${encodeURIComponent(query)}&type=pickup`)
              .then(response => response.json());
          },
          minChars: 3,
          template: function(item) {
            return `
              <div class="autocomplete-item-custom">
                <i class="bi ${item.icon || 'bi-geo-alt'} autocomplete-item-icon"></i>
                <div class="autocomplete-item-content">
                  <div class="autocomplete-item-title">${item.label}</div>
                  <div class="autocomplete-item-subtitle">${item.subtitle}</div>
                </div>
              </div>
            `;
          }
        });
      });
      
      // Auto-complete for dropoff addresses
      document.querySelectorAll('.dropoff-address').forEach(input => {
        const inputId = input.id || generateUniqueId();
        if (!input.id) input.id = inputId;
        
        new AutoComplete(inputId, {
          source: function(query) {
            return fetch(`/api/search-addresses?q=${encodeURIComponent(query)}&type=dropoff`)
              .then(response => response.json());
          },
          minChars: 3,
          template: function(item) {
            return `
              <div class="autocomplete-item-custom">
                <i class="bi ${item.icon || 'bi-geo-alt-fill'} autocomplete-item-icon"></i>
                <div class="autocomplete-item-content">
                  <div class="autocomplete-item-title">${item.label}</div>
                  <div class="autocomplete-item-subtitle">${item.subtitle}</div>
                </div>
              </div>
            `;
          }
        });
      });
      
      // Helper function to generate unique IDs for dynamically created inputs
      function generateUniqueId() {
        return 'input-' + Math.random().toString(36).substr(2, 9);
      }
      
      // Re-initialize auto-complete when new address fields are added
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList') {
            mutation.addedNodes.forEach(function(node) {
              if (node.nodeType === Node.ELEMENT_NODE) {
                // Check for new address inputs
                const pickupInputs = node.querySelectorAll('.pickup-address:not([data-autocomplete])');
                const dropoffInputs = node.querySelectorAll('.dropoff-address:not([data-autocomplete])');
                
                if (pickupInputs.length > 0 || dropoffInputs.length > 0) {
                  initializeStudentAutoComplete();
                }
              }
            });
          }
        });
      });
      
      // Observe changes in the modals
      const modals = document.querySelectorAll('.modal-body');
      modals.forEach(modal => {
        observer.observe(modal, { childList: true, subtree: true });
      });
      
      // Mark initialized inputs
      document.querySelectorAll('.pickup-address, .dropoff-address').forEach(input => {
        input.setAttribute('data-autocomplete', 'true');
      });
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Student Management - {{.User.Username}}</h2>
      <div>
        <a href="/driver-dashboard" class="btn btn-outline-primary me-2">Back to Dashboard</a>
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
      </div>
    </div>

    <!-- Add New Student Button -->
    <div class="mb-4">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
        + Add New Student
      </button>
    </div>

    <!-- Students List -->
    <div class="row">
      {{range .Students}}
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{.Name}} - Position #{{.PositionNumber}}</h5>
            <div>
              {{if .Active}}
                <span class="badge bg-success">Active</span>
              {{else}}
                <span class="badge bg-secondary">Inactive</span>
              {{end}}
            </div>
          </div>
          <div class="card-body">
            <p><strong>Guardian:</strong> {{.Guardian}}</p>
            <p><strong>Phone:</strong> {{.PhoneNumber}}
              {{if .AltPhoneNumber}}<br><strong>Alt Phone:</strong> {{.AltPhoneNumber}}{{end}}
            </p>
            <p><strong>Pickup Time:</strong> {{.PickupTime}} | <strong>Dropoff Time:</strong> {{.DropoffTime}}</p>

            <h6>Locations:</h6>
            {{range .Locations}}
            <div class="mb-2">
              <span class="badge {{if eq .Type "pickup"}}bg-info{{else}}bg-warning{{end}}">{{.Type}}</span>
              <strong>{{.Address}}</strong>
              {{if .Description}}<br><small class="text-muted">{{.Description}}</small>{{end}}
            </div>
            {{end}}

            <div class="mt-3">
              <button class="btn btn-sm btn-outline-secondary" onclick="editStudent('{{.StudentID}}', '{{.Name}}', '{{.PhoneNumber}}', '{{.AltPhoneNumber}}', '{{.Guardian}}', '{{.PickupTime}}', '{{.DropoffTime}}', {{.PositionNumber}}, '{{.RouteID}}', {{.Active}}, {{json .Locations}})">
                Edit
              </button>
              <form method="POST" action="/remove-student" class="d-inline" onsubmit="return confirm('Are you sure you want to remove this student?')">
                <input type="hidden" name="student_id" value="{{.StudentID}}">
                <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {{else}}
      <div class="col-12">
        <div class="alert alert-info">
          <h5>No Students Added Yet</h5>
          <p>Click "Add New Student" to add your first student.</p>
        </div>
      </div>
      {{end}}
    </div>
  </div>

  <!-- Add Student Modal -->
  <div class="modal fade" id="addStudentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="POST" action="/add-student">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Student Name</label>
                  <input type="text" class="form-control" name="name" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Position Number</label>
                  <input type="number" class="form-control" name="position_number" required>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Guardian/Contact Person</label>
                  <input type="text" class="form-control" name="guardian" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Route</label>
                  <select name="route_id" class="form-select" required>
                    <option value="">Select Route</option>
                    {{range .Routes}}
                    <option value="{{.RouteID}}">{{.RouteName}}</option>
                    {{end}}
                  </select>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Phone Number</label>
                  <input type="tel" class="form-control" name="phone_number" required>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Alt Phone Number</label>
                  <input type="tel" class="form-control" name="alt_phone_number">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Pickup Time</label>
                  <input type="time" class="form-control" name="pickup_time" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Dropoff Time</label>
                  <input type="time" class="form-control" name="dropoff_time" required>
                </div>
              </div>
            </div>

            <h6>Pickup Locations</h6>
            <div id="pickupLocations">
              <div class="row mb-2">
                <div class="col-md-6">
                  <input type="text" class="form-control" name="pickup_address" placeholder="Pickup Address">
                </div>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="pickup_description" placeholder="Description (optional)">
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addPickupLocation()">+ Add Another Pickup Location</button>

            <h6>Dropoff Locations</h6>
            <div id="dropoffLocations">
              <div class="row mb-2">
                <div class="col-md-6">
                  <input type="text" class="form-control" name="dropoff_address" placeholder="Dropoff Address">
                </div>
                <div class="col-md-6">
                  <input type="text" class="form-control" name="dropoff_description" placeholder="Description (optional)">
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addDropoffLocation()">+ Add Another Dropoff Location</button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Student</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div class="modal fade" id="editStudentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="POST" action="/edit-student" id="editStudentForm">
          <input type="hidden" name="student_id" id="edit_student_id">
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Student Name</label>
                  <input type="text" class="form-control" name="name" id="edit_name" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Position Number</label>
                  <input type="number" class="form-control" name="position_number" id="edit_position_number" required>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Guardian/Contact Person</label>
                  <input type="text" class="form-control" name="guardian" id="edit_guardian" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Route</label>
                  <select name="route_id" id="edit_route_id" class="form-select" required>
                    <option value="">Select Route</option>
                    {{range .Routes}}
                    <option value="{{.RouteID}}">{{.RouteName}}</option>
                    {{end}}
                  </select>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Phone Number</label>
                  <input type="tel" class="form-control" name="phone_number" id="edit_phone_number" required>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Alt Phone Number</label>
                  <input type="tel" class="form-control" name="alt_phone_number" id="edit_alt_phone_number">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="active" id="edit_active">
                    <label class="form-check-label">Active</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Pickup Time</label>
                  <input type="time" class="form-control" name="pickup_time" id="edit_pickup_time" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Dropoff Time</label>
                  <input type="time" class="form-control" name="dropoff_time" id="edit_dropoff_time" required>
                </div>
              </div>
            </div>

            <h6>Pickup Locations</h6>
            <div id="editPickupLocations"></div>
            <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addEditPickupLocation()">+ Add Another Pickup Location</button>

            <h6>Dropoff Locations</h6>
            <div id="editDropoffLocations"></div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditDropoffLocation()">+ Add Another Dropoff Location</button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Student</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function addPickupLocation() {
      const container = document.getElementById('pickupLocations');
      const div = document.createElement('div');
      div.className = 'row mb-2';
      div.innerHTML = `
        <div class="col-md-6">
          <input type="text" class="form-control" name="pickup_address" placeholder="Pickup Address">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" name="pickup_description" placeholder="Description (optional)">
        </div>
      `;
      container.appendChild(div);
    }

    function addDropoffLocation() {
      const container = document.getElementById('dropoffLocations');
      const div = document.createElement('div');
      div.className = 'row mb-2';
      div.innerHTML = `
        <div class="col-md-6">
          <input type="text" class="form-control" name="dropoff_address" placeholder="Dropoff Address">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" name="dropoff_description" placeholder="Description (optional)">
        </div>
      `;
      container.appendChild(div);
    }

    function addEditPickupLocation() {
      const container = document.getElementById('editPickupLocations');
      const div = document.createElement('div');
      div.className = 'row mb-2';
      div.innerHTML = `
        <div class="col-md-6">
          <input type="text" class="form-control" name="pickup_address" placeholder="Pickup Address">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" name="pickup_description" placeholder="Description (optional)">
        </div>
      `;
      container.appendChild(div);
    }

    function addEditDropoffLocation() {
      const container = document.getElementById('editDropoffLocations');
      const div = document.createElement('div');
      div.className = 'row mb-2';
      div.innerHTML = `
        <div class="col-md-6">
          <input type="text" class="form-control" name="dropoff_address" placeholder="Dropoff Address">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" name="dropoff_description" placeholder="Description (optional)">
        </div>
      `;
      container.appendChild(div);
    }

    function editStudent(student_id, name, phone, altPhone, guardian, pickupTime, dropoffTime, position, routeId, active, locations) {
      document.getElementById('edit_student_id').value = student_id;
      document.getElementById('edit_name').value = name;
      document.getElementById('edit_phone_number').value = phone;
      document.getElementById('edit_alt_phone_number').value = altPhone;
      document.getElementById('edit_guardian').value = guardian;
      document.getElementById('edit_pickup_time').value = pickupTime;
      document.getElementById('edit_dropoff_time').value = dropoffTime;
      document.getElementById('edit_position_number').value = position;
      document.getElementById('edit_route_id').value = routeId;
      document.getElementById('edit_active').checked = active;

      // Clear existing locations
      document.getElementById('editPickupLocations').innerHTML = '';
      document.getElementById('editDropoffLocations').innerHTML = '';

      // Add existing locations
      locations.forEach(location => {
        if (location.Type === 'pickup') {
          const container = document.getElementById('editPickupLocations');
          const div = document.createElement('div');
          div.className = 'row mb-2';
          div.innerHTML = `
            <div class="col-md-6">
              <input type="text" class="form-control" name="pickup_address" value="${location.Address}" placeholder="Pickup Address">
            </div>
            <div class="col-md-6">
              <input type="text" class="form-control" name="pickup_description" value="${location.Description}" placeholder="Description (optional)">
            </div>
          `;
          container.appendChild(div);
        } else if (location.Type === 'dropoff') {
          const container = document.getElementById('editDropoffLocations');
          const div = document.createElement('div');
          div.className = 'row mb-2';
          div.innerHTML = `
            <div class="col-md-6">
              <input type="text" class="form-control" name="dropoff_address" value="${location.Address}" placeholder="Dropoff Address">
            </div>
            <div class="col-md-6">
              <input type="text" class="form-control" name="dropoff_description" value="${location.Description}" placeholder="Description (optional)">
            </div>
          `;
          container.appendChild(div);
        }
      });

      // Ensure at least one location input for each type
      if (document.getElementById('editPickupLocations').children.length === 0) {
        addEditPickupLocation();
      }
      if (document.getElementById('editDropoffLocations').children.length === 0) {
        addEditDropoffLocation();
      }

      new bootstrap.Modal(document.getElementById('editStudentModal')).show();
    }
  </script>
</body>
</html>
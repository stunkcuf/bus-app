<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import ECSE Report - Fleet Management System</title>
  <!-- Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <!-- Modern Theme CSS - Primary styling -->
  <link rel="stylesheet" href="/static/modern_theme.css">
  <!-- Help System CSS -->
  <link rel="stylesheet" href="/static/help_system.css">
  <link rel="stylesheet" href="/static/enhanced_help_system.css">
  <!-- Auto-complete CSS -->
  <link rel="stylesheet" href="/static/autocomplete.css">
  <style nonce="{{.CSPNonce}}">
    /* Custom file upload styling */
    .file-upload-area {
      border: 3px dashed var(--border-color);
      border-radius: var(--border-radius-lg);
      padding: var(--space-xxl);
      text-align: center;
      transition: all var(--transition-base);
      cursor: pointer;
      background: var(--color-bg-secondary);
      min-height: var(--touch-target-large);
    }
    
    .file-upload-area:hover {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }
    
    .file-upload-area.drag-over {
      border-color: var(--color-success);
      background: var(--color-success-light);
      transform: scale(1.02);
    }
    
    .file-input {
      display: none;
    }
    
    .file-info {
      background: var(--color-bg-tertiary);
      border-radius: var(--border-radius-base);
      padding: var(--space-lg);
      margin-top: var(--space-md);
      display: none;
    }
    
    .file-info.show {
      display: block;
    }
    
    .format-table {
      font-size: var(--font-size-base);
    }
    
    .format-table th {
      background: var(--color-bg-tertiary);
      font-weight: 600;
    }
    
    .ecse-info-box {
      background: var(--color-info-light);
      border-radius: var(--border-radius-lg);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl);
      border: 1px solid var(--color-info);
    }
    
    .ecse-info-box h5 {
      color: var(--color-info-dark);
      margin-bottom: var(--space-sm);
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Navigation Component -->
    {{template "navigation" (dict "Navigation" .Navigation "CSPNonce" .CSPNonce "ShowHelpButton" .ShowHelpButton "PageDescription" "Import ECSE student data from Excel")}}
    
    <!-- Page Actions -->
    <header class="page-actions">

    <!-- ECSE Info Box -->
    <div class="ecse-info-box">
      <h2><i class="bi bi-info-circle" aria-hidden="true"></i>What is ECSE?</h2>
      <p>Early Childhood Special Education (ECSE) reports contain data about special education services provided to young children, including student information, enrollment status, services received, and transportation details.</p>
    </div>

    <!-- Alerts -->
    {{if .Data.Error}}
    <div class="alert alert-danger" role="alert">
      <div class="alert-header">
        <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
        <strong>Import Error</strong>
      </div>
      <p>{{.Data.Error}}</p>
    </div>
    {{end}}
    
    {{if .Data.Success}}
    <div class="alert alert-success" role="alert">
      <div class="alert-header">
        <i class="bi bi-check-circle-fill" aria-hidden="true"></i>
        <strong>Success!</strong>
      </div>
      <p>{{.Data.Success}}</p>
    </div>
    {{end}}

    <!-- Main Import Card -->
    <main id="main-content" class="main-content">
      <div class="card">
        <div class="card-header">
          <h2>
            <i class="bi bi-file-earmark-excel" aria-hidden="true"></i>
            Upload ECSE Report
          </h2>
          <p class="card-description">Select your Excel file to import ECSE student data</p>
        </div>
        
        <div class="card-body">
          <form method="POST" action="/import-ecse" enctype="multipart/form-data" id="importForm" class="accessible-form">
            <input type="hidden" name="csrf_token" value="{{.Data.CSRFToken}}">
            
            <div class="form-group">
              <label for="fileInput" class="form-label required">
                <i class="bi bi-file-earmark-excel" aria-hidden="true"></i>
                Excel File
              </label>
              <div class="form-help">
                <i class="bi bi-info-circle form-help-icon" aria-hidden="true"></i>
                Choose your ECSE data file in Excel format (.xlsx or .xls)
              </div>
              
              <div class="file-upload-area" id="uploadArea">
                <i class="bi bi-cloud-arrow-up" aria-hidden="true"></i>
                <h3>Drag & Drop Excel File Here</h3>
                <p>or click to browse for file</p>
                <input type="file" name="excel_file" id="fileInput" class="file-input" accept=".xlsx,.xls" required>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                  <i class="bi bi-folder2-open" aria-hidden="true"></i>
                  Choose File
                </button>
              </div>
              
              <div class="file-info" id="fileInfo">
                <div class="file-info-content">
                  <div class="file-info-main">
                    <i class="bi bi-file-earmark-excel" aria-hidden="true"></i>
                    <span id="fileName"></span>
                  </div>
                  <span class="file-info-size" id="fileSize"></span>
                </div>
              </div>
            </div>
            
            <div class="form-buttons">
              <button type="submit" class="form-btn form-btn-primary" id="importBtn" disabled>
                <i class="bi bi-upload" aria-hidden="true"></i>
                Import ECSE Data
              </button>
              <button type="reset" class="form-btn form-btn-secondary" id="resetBtn">
                <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                Reset Form
              </button>
            </div>
          </form>

          <!-- Instructions -->
          <div class="card-section">
            <h3>
              <i class="bi bi-info-circle" aria-hidden="true"></i>
              Excel File Format Requirements
            </h3>
            
            <div class="info-box">
              <p>Your ECSE Excel file should contain the following types of data:</p>
              <div class="table-responsive">
                <table class="table format-table">
                  <thead>
                    <tr>
                      <th scope="col">Data Category</th>
                      <th scope="col">Description</th>
                      <th scope="col">Examples</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <th scope="row">Student Information</th>
                      <td>Basic student demographics</td>
                      <td>Name, ID, DOB, Grade</td>
                    </tr>
                    <tr>
                      <th scope="row">Enrollment Status</th>
                      <td>Current enrollment information</td>
                      <td>Active, Inactive, Transfer</td>
                    </tr>
                    <tr>
                      <th scope="row">Service Details</th>
                      <td>Special education services</td>
                      <td>IEP, Speech, OT, PT</td>
                    </tr>
                    <tr>
                      <th scope="row">Transportation</th>
                      <td>Transportation requirements</td>
                      <td>Bus Route, Special Needs</td>
                    </tr>
                    <tr>
                      <th scope="row">Contact Information</th>
                      <td>Parent/Guardian contacts</td>
                      <td>Phone, Email, Address</td>
                    </tr>
                    <tr>
                      <th scope="row">Assessment Data</th>
                      <td>Evaluation and progress data</td>
                      <td>Test scores, Goals, Progress</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div class="info-box">
              <h4>Important Notes:</h4>
              <ul class="checklist">
                <li>The system will automatically detect column headers</li>
                <li>Student IDs must be unique</li>
                <li>Dates should be in MM/DD/YYYY or similar format</li>
                <li>The system will validate data and report any issues</li>
                <li>Maximum file size: 10MB</li>
                <li>Supported formats: .xlsx and .xls</li>
                <li>Multiple sheets will be processed if present</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="/static/accessible_forms.js"></script>
  <script src="/static/workflow_guides.js"></script>
  <script nonce="{{.CSPNonce}}">
    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.getElementById('uploadArea');
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      const importBtn = document.getElementById('importBtn');
      const importForm = document.getElementById('importForm');
      const resetBtn = document.getElementById('resetBtn');
      
      // Initialize accessible form
      const accessibleForm = new AccessibleForm(importForm, {
        customValidators: {
          'excel_file': function(value, field) {
            if (!field.files || field.files.length === 0) {
              return 'Please select an Excel file';
            }
            
            const file = field.files[0];
            const validExtensions = ['.xls', '.xlsx'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
              return 'Please select a valid Excel file (.xlsx or .xls)';
            }
            
            if (file.size > 10 * 1024 * 1024) {
              return 'File size must be less than 10MB';
            }
            
            return null;
          }
        }
      });
      
      // File input change handler
      fileInput.addEventListener('change', function(e) {
        handleFileSelect(e.target.files);
      });
      
      // Drag and drop handlers
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add('drag-over');
      });
      
      uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('drag-over');
      });
      
      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleFileSelect(files);
        }
      });
      
      // Click to upload
      uploadArea.addEventListener('click', function(e) {
        if (e.target.tagName !== 'BUTTON') {
          fileInput.click();
        }
      });
      
      // Handle file selection
      function handleFileSelect(files) {
        if (files.length > 0) {
          const file = files[0];
          
          // Update UI
          fileName.textContent = file.name;
          fileSize.textContent = formatFileSize(file.size);
          fileInfo.classList.add('show');
          importBtn.disabled = false;
          
          // Update upload area text
          uploadArea.querySelector('h3').textContent = 'File Selected';
          uploadArea.querySelector('p').textContent = 'Click to change file';
          
          // Announce to screen readers
          const liveRegion = document.getElementById('form-live-region');
          if (liveRegion) {
            liveRegion.textContent = `File selected: ${file.name}, size: ${formatFileSize(file.size)}`;
          }
        }
      }
      
      // Format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      // Form submission
      importForm.addEventListener('submit', function(e) {
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="bi bi-hourglass-split" aria-hidden="true"></i> Processing ECSE Data...';
      });
      
      // Reset form handler
      resetBtn.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.value = '';
        fileInfo.classList.remove('show');
        importBtn.disabled = true;
        uploadArea.querySelector('h3').textContent = 'Drag & Drop Excel File Here';
        uploadArea.querySelector('p').textContent = 'or click to browse for file';
        
        // Reset validation
        accessibleForm.reset();
      });
      
      // Initialize workflow guides for this page
      if (window.workflowGuides) {
        window.workflowGuides.autoShowGuide();
      }
    });
  </script>
</body>
</html>

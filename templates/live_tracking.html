<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live GPS Tracking - Fleet Management System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/static/modern_theme.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .tracking-container {
      padding: 20px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header-bar {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px 25px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    
    .main-content {
      display: flex;
      gap: 20px;
      flex: 1;
      min-height: 0;
    }
    
    #map {
      flex: 1;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .sidebar {
      width: 350px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    
    .bus-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid #4a90e2;
    }
    
    .bus-card:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }
    
    .bus-card.offline {
      border-left-color: #dc3545;
      opacity: 0.7;
    }
    
    .bus-card.stopped {
      border-left-color: #ffc107;
    }
    
    .bus-card.active {
      border-left-color: #28a745;
    }
    
    .bus-number {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }
    
    .bus-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    
    .bus-status {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-stopped {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-offline {
      background: #f8d7da;
      color: #721c24;
    }
    
    .speed-indicator {
      font-size: 0.9rem;
      color: #6c757d;
    }
    
    .filter-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .filter-btn {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 20px;
      padding: 5px 15px;
      margin: 5px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .filter-btn.active {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .bus-marker {
      background: #4a90e2;
      border: 3px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    
    .route-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    
    .eta-badge {
      background: #17a2b8;
      color: white;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.85rem;
    }
    
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .connection-status.connected {
      background: #d4edda;
      color: #155724;
    }
    
    .connection-status.disconnected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .pulse {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- Connection Status -->
  <div class="connection-status connected" id="connectionStatus">
    <span class="pulse"></span>
    <span>Live Tracking Active</span>
  </div>

  <div class="tracking-container">
    <!-- Header -->
    <div class="header-bar">
      <div>
        <h1 class="h3 mb-0">
          <i class="bi bi-geo-alt-fill"></i> Live GPS Tracking
        </h1>
      </div>
      <div>
        <span class="me-3">{{.User.Username}}</span>
        <a href="/dashboard" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <!-- Map -->
      <div id="map"></div>
      
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="activeBusCount">0</div>
            <div class="stat-label">Active Buses</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="stat-value" id="totalStudents">0</div>
            <div class="stat-label">Students En Route</div>
          </div>
        </div>
        
        <!-- Filters -->
        <div class="filter-section">
          <h5 class="mb-3">Filter Buses</h5>
          <div>
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="active">Active</button>
            <button class="filter-btn" data-filter="stopped">Stopped</button>
            <button class="filter-btn" data-filter="offline">Offline</button>
          </div>
        </div>
        
        <!-- Bus List -->
        <div>
          <h5 class="mb-3">Fleet Status</h5>
          <div id="busList">
            <!-- Bus cards will be added here dynamically -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // Initialize map
    const map = L.map('map').setView([40.7128, -74.0060], 13); // Default to NYC
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    // Store bus markers
    const busMarkers = {};
    const busData = {};
    let selectedBusId = null;
    
    // Custom bus icon
    const createBusIcon = (busNumber, status) => {
      const color = status === 'active' ? '#28a745' : 
                   status === 'stopped' ? '#ffc107' : '#dc3545';
      
      return L.divIcon({
        html: `<div class="bus-marker" style="background: ${color};">${busNumber}</div>`,
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20],
        className: ''
      });
    };
    
    // Update bus position on map
    function updateBusPosition(data) {
      const busId = data.vehicle_id;
      
      // Store bus data
      busData[busId] = data;
      
      // Update or create marker
      if (busMarkers[busId]) {
        // Update existing marker
        busMarkers[busId].setLatLng([data.latitude, data.longitude]);
        busMarkers[busId].setIcon(createBusIcon(busId, data.status));
        
        // Update popup
        busMarkers[busId].bindPopup(`
          <strong>Bus ${busId}</strong><br>
          Status: ${data.status}<br>
          Speed: ${data.speed.toFixed(1)} mph<br>
          Driver: ${data.driver_id}<br>
          Route: ${data.route_id}<br>
          Last Update: ${new Date(data.timestamp).toLocaleTimeString()}
        `);
      } else {
        // Create new marker
        const marker = L.marker([data.latitude, data.longitude], {
          icon: createBusIcon(busId, data.status)
        }).addTo(map);
        
        marker.bindPopup(`
          <strong>Bus ${busId}</strong><br>
          Status: ${data.status}<br>
          Speed: ${data.speed.toFixed(1)} mph<br>
          Driver: ${data.driver_id}<br>
          Route: ${data.route_id}<br>
          Last Update: ${new Date(data.timestamp).toLocaleTimeString()}
        `);
        
        marker.on('click', () => selectBus(busId));
        
        busMarkers[busId] = marker;
      }
      
      // Update sidebar
      updateBusCard(data);
      updateStats();
    }
    
    // Update bus card in sidebar
    function updateBusCard(data) {
      const busId = data.vehicle_id;
      let card = document.getElementById(`bus-${busId}`);
      
      if (!card) {
        // Create new card
        card = document.createElement('div');
        card.id = `bus-${busId}`;
        card.className = `bus-card ${data.status}`;
        card.onclick = () => selectBus(busId);
        document.getElementById('busList').appendChild(card);
      }
      
      // Update card content
      card.className = `bus-card ${data.status}`;
      card.innerHTML = `
        <div class="bus-number">Bus ${busId}</div>
        <div class="route-info">
          <strong>Route:</strong> ${data.route_id || 'Not Assigned'}<br>
          <strong>Driver:</strong> ${data.driver_id || 'Not Assigned'}
        </div>
        <div class="bus-info">
          <span class="bus-status status-${data.status}">${data.status}</span>
          <span class="speed-indicator">
            <i class="bi bi-speedometer2"></i> ${data.speed.toFixed(1)} mph
          </span>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="bi bi-clock"></i> ${new Date(data.timestamp).toLocaleTimeString()}
          </small>
        </div>
      `;
    }
    
    // Select bus and center map
    function selectBus(busId) {
      selectedBusId = busId;
      const data = busData[busId];
      
      if (data && busMarkers[busId]) {
        map.setView([data.latitude, data.longitude], 16);
        busMarkers[busId].openPopup();
        
        // Highlight selected card
        document.querySelectorAll('.bus-card').forEach(card => {
          card.style.border = card.id === `bus-${busId}` 
            ? '2px solid #4a90e2' : '';
        });
      }
    }
    
    // Update statistics
    function updateStats() {
      const activeBuses = Object.values(busData).filter(b => b.status === 'active').length;
      const totalBuses = Object.keys(busData).length;
      
      document.getElementById('activeBusCount').textContent = activeBuses;
      // Simulated student count - would come from real data
      document.getElementById('totalStudents').textContent = activeBuses * 25;
    }
    
    // Filter buses
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const filter = this.dataset.filter;
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Filter bus cards
        document.querySelectorAll('.bus-card').forEach(card => {
          const status = busData[card.id.replace('bus-', '')].status;
          card.style.display = (filter === 'all' || status === filter) ? 'block' : 'none';
        });
        
        // Filter map markers
        Object.keys(busMarkers).forEach(busId => {
          const status = busData[busId].status;
          if (filter === 'all' || status === filter) {
            busMarkers[busId].addTo(map);
          } else {
            map.removeLayer(busMarkers[busId]);
          }
        });
      });
    });
    
    // Connect to SSE for real-time updates
    function connectSSE() {
      console.log('Attempting to connect to GPS stream...');
      const eventSource = new EventSource('/api/gps/stream', {
        withCredentials: true
      });
      
      eventSource.onopen = function() {
        console.log('Connected to GPS stream');
        document.getElementById('connectionStatus').className = 'connection-status connected';
        document.getElementById('connectionStatus').innerHTML = `
          <span class="pulse"></span>
          <span>Live Tracking Active</span>
        `;
      };
      
      // Listen for the initial connection event
      eventSource.addEventListener('connected', function(event) {
        console.log('Connection confirmed:', event.data);
      });
      
      // Listen for GPS updates
      eventSource.addEventListener('gps_update', function(event) {
        console.log('Received GPS update:', event.data);
        try {
          const data = JSON.parse(event.data);
          console.log('Parsed GPS data:', data);
          updateBusPosition(data);
        } catch (error) {
          console.error('Error parsing GPS data:', error, 'Raw data:', event.data);
        }
      });
      
      // Generic message handler (for any events without specific type)
      eventSource.onmessage = function(event) {
        console.log('Received generic message:', event.data);
      };
      
      eventSource.onerror = function() {
        console.error('SSE connection error');
        document.getElementById('connectionStatus').className = 'connection-status disconnected';
        document.getElementById('connectionStatus').innerHTML = `
          <i class="bi bi-exclamation-circle"></i>
          <span>Connection Lost</span>
        `;
        
        // Reconnect after 5 seconds
        setTimeout(connectSSE, 5000);
      };
      
      return eventSource;
    }
    
    // Simulate GPS updates for demo
    function simulateGPSUpdates() {
      const buses = ['101', '102', '103', '104', '105'];
      const routes = ['Route A', 'Route B', 'Route C'];
      const drivers = ['John Smith', 'Jane Doe', 'Bob Johnson'];
      
      buses.forEach((busId, index) => {
        // Initial position
        const baseLat = 40.7128 + (Math.random() - 0.5) * 0.1;
        const baseLng = -74.0060 + (Math.random() - 0.5) * 0.1;
        
        // Create initial update
        const initialData = {
          vehicle_id: busId,
          latitude: baseLat,
          longitude: baseLng,
          speed: Math.random() * 30,
          heading: Math.random() * 360,
          timestamp: new Date().toISOString(),
          driver_id: drivers[index % drivers.length],
          route_id: routes[index % routes.length],
          status: index < 3 ? 'active' : index < 4 ? 'stopped' : 'offline'
        };
        
        updateBusPosition(initialData);
        
        // Simulate movement for active buses
        if (initialData.status === 'active') {
          setInterval(() => {
            const currentData = busData[busId];
            const newData = {
              ...currentData,
              latitude: currentData.latitude + (Math.random() - 0.5) * 0.001,
              longitude: currentData.longitude + (Math.random() - 0.5) * 0.001,
              speed: 15 + Math.random() * 20,
              heading: currentData.heading + (Math.random() - 0.5) * 10,
              timestamp: new Date().toISOString()
            };
            updateBusPosition(newData);
          }, 3000 + Math.random() * 2000);
        }
      });
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      // Try to connect to real SSE, fall back to simulation
      try {
        connectSSE(); // Connect to real SSE for live GPS data
        // simulateGPSUpdates(); // Fallback simulation disabled - using real SSE
      } catch (error) {
        console.log('Falling back to simulated GPS data');
        simulateGPSUpdates();
      }
      
      // Center map on first bus after a delay
      setTimeout(() => {
        const firstBusId = Object.keys(busData)[0];
        if (firstBusId) {
          selectBus(firstBusId);
        }
      }, 1000);
    });
  </script>
</body>
</html>
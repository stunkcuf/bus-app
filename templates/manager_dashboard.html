<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard - Fleet Management System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/static/accessible_design_system.css">
  <link rel="stylesheet" href="/static/visual_hierarchy.css">
  <link rel="stylesheet" href="/static/help_system.css">
  <link rel="stylesheet" href="/static/enhanced_help_system.css">
  <link rel="stylesheet" href="/static/mobile_responsive.css">
  <link rel="stylesheet" href="/static/autocomplete.css">
  <style nonce="{{.CSPNonce}}">
    /* Dashboard specific styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    
    .metric-icon {
      font-size: 2.5rem;
      opacity: 0.9;
    }
    
    .metric-value {
      font-size: var(--font-size-xl);
      font-weight: 700;
      margin: var(--space-sm) 0;
    }
    
    .metric-label {
      font-size: var(--font-size-base);
      color: var(--color-text-secondary);
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }
    
    .quick-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: var(--space-lg);
      background: var(--color-bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      text-decoration: none;
      color: var(--color-text-primary);
      transition: all var(--transition-base);
      min-height: var(--touch-target-large);
    }
    
    .quick-action:hover {
      background: var(--color-primary-light);
      border-color: var(--color-primary);
      transform: translateY(-2px);
    }
    
    .quick-action i {
      font-size: 2rem;
      margin-bottom: var(--space-sm);
      color: var(--color-primary);
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <!-- Navigation Component -->
    {{$pageDesc := printf "Welcome back, %s" .User.Username}}
    {{template "navigation" (dict "Navigation" .Navigation "CSPNonce" .CSPNonce "ShowHelpButton" .ShowHelpButton "PageDescription" $pageDesc)}}
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
      <!-- Quick Search Bar -->
      <section class="content-section" aria-labelledby="search-heading">
        <h2 id="search-heading" class="section-heading sr-only">Quick Search</h2>
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="quickSearchBus" class="form-label">Search Bus</label>
                <input type="text" id="quickSearchBus" class="form-control" 
                       placeholder="Type bus ID or model...">
              </div>
              <div class="col-md-6 mb-3">
                <label for="quickSearchDriver" class="form-label">Search Driver</label>
                <input type="text" id="quickSearchDriver" class="form-control" 
                       placeholder="Type driver name...">
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Dashboard Shortcuts -->
      {{template "dashboard-shortcuts" (dict "UserRole" .User.Role "CSPNonce" .CSPNonce)}}
      
      <!-- Metrics Cards -->
      <section class="content-section" aria-labelledby="metrics-heading">
        <h2 id="metrics-heading" class="section-heading">
          <i class="bi bi-speedometer2" aria-hidden="true"></i>
          Fleet Overview
        </h2>
        <div class="data-grid-primary">
          <!-- Total Buses -->
          <div class="card">
            <div class="card-body text-center">
              <i class="bi bi-bus-front-fill metric-icon" style="color: var(--color-primary);" aria-hidden="true"></i>
              <div class="metric-value">{{.TotalBuses}}</div>
              <div class="metric-label">Total Buses</div>
            </div>
          </div>
          
          <!-- Active Drivers -->
          <div class="card">
            <div class="card-body text-center">
              <i class="bi bi-people-fill metric-icon" style="color: var(--color-success);" aria-hidden="true"></i>
              <div class="metric-value">{{.TotalDrivers}}</div>
              <div class="metric-label">Active Drivers</div>
            </div>
          </div>
          
          <!-- Total Students -->
          <div class="card">
            <div class="card-body text-center">
              <i class="bi bi-person-badge-fill metric-icon" style="color: var(--color-info);" aria-hidden="true"></i>
              <div class="metric-value">{{.TotalStudents}}</div>
              <div class="metric-label">Total Students</div>
            </div>
          </div>
          
          <!-- Active Routes -->
          <div class="card">
            <div class="card-body text-center">
              <i class="bi bi-map-fill metric-icon" style="color: var(--color-warning);" aria-hidden="true"></i>
              <div class="metric-value">{{.ActiveRoutes}}</div>
              <div class="metric-label">Active Routes</div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Quick Actions -->
      <section class="content-section" aria-labelledby="actions-heading">
        <h2 id="actions-heading" class="section-heading">
          <i class="bi bi-lightning-charge-fill" aria-hidden="true"></i>
          Quick Actions
        </h2>
        <div class="quick-actions" data-help="quick-actions">
          <a href="/fleet" class="quick-action" data-help="manage-fleet" data-help-title="Manage Fleet" data-help-content="View and manage all buses and vehicles in your fleet. Check maintenance status, update vehicle information, and track availability.">
            <i class="bi bi-bus-front" aria-hidden="true"></i>
            <span>Manage Fleet</span>
          </a>
          
          <a href="/assign-routes" class="quick-action" data-help="assign-routes" data-help-title="Assign Routes" data-help-content="Assign drivers to specific bus routes. Ensure each route has a driver and vehicle assigned before the start of each day.">
            <i class="bi bi-diagram-3" aria-hidden="true"></i>
            <span>Assign Routes</span>
          </a>
          
          <a href="/students" class="quick-action" data-help="manage-students" data-help-title="Manage Students" data-help-content="Add, edit, or remove students from the system. Manage student information, routes, and pickup/dropoff schedules.">
            <i class="bi bi-people" aria-hidden="true"></i>
            <span>Manage Students</span>
          </a>
          
          <a href="/ecse-dashboard" class="quick-action" data-help="ecse-dashboard" data-help-title="ECSE Dashboard" data-help-content="View and manage Early Childhood Special Education students. Monitor transportation requirements and IEP statuses.">
            <i class="bi bi-mortarboard-fill" aria-hidden="true"></i>
            <span>ECSE Students</span>
          </a>
          
          <a href="/import-ecse" class="quick-action" data-help="import-ecse" data-help-title="Import ECSE Data" data-help-content="Import Early Childhood Special Education student data from Excel files. This helps manage special needs transportation requirements.">
            <i class="bi bi-file-earmark-excel" aria-hidden="true"></i>
            <span>Import ECSE</span>
          </a>
          
          <a href="/import-data-wizard" class="quick-action" data-help="import-wizard" data-help-title="Import Data Wizard" data-help-content="Use the step-by-step wizard to import any type of data with automatic column mapping and validation.">
            <i class="bi bi-cloud-upload" aria-hidden="true"></i>
            <span>Import Wizard</span>
          </a>
          
          <a href="/monthly-mileage-reports" class="quick-action" data-help="monthly-mileage" data-help-title="Monthly Mileage" data-help-content="View monthly mileage reports for all buses. Track total miles driven, fuel consumption, and identify high-usage vehicles.">
            <i class="bi bi-speedometer2" aria-hidden="true"></i>
            <span>Monthly Mileage</span>
          </a>
          
          <a href="/view-mileage-reports" class="quick-action" data-help="view-reports" data-help-title="View Reports" data-help-content="Access various reports including mileage, maintenance history, and driver performance. Export reports for record keeping.">
            <i class="bi bi-graph-up" aria-hidden="true"></i>
            <span>View Reports</span>
          </a>
          
          <a href="/approve-users" class="quick-action" data-help="approve-users" data-help-title="Approve Users" data-help-content="Review and approve new driver registrations. New users cannot access the system until approved by a manager.">
            <i class="bi bi-person-check" aria-hidden="true"></i>
            <span>Approve Users</span>
          </a>
        </div>
      </section>
      
      <!-- Maintenance Alerts -->
      {{if .MaintenanceAlerts}}
      <section aria-labelledby="alerts-heading">
        <h2 id="alerts-heading">Maintenance Alerts</h2>
        <div class="card">
          <div class="card-body">
            {{range .MaintenanceAlerts}}
            <div class="alert alert-warning" role="alert">
              <div class="alert-header">
                <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                <strong>Maintenance Required</strong>
              </div>
              <p>Bus {{.BusID}} - {{.Message}}</p>
            </div>
            {{end}}
          </div>
        </div>
      </section>
      {{end}}
      
      <!-- Recent Activity -->
      <section aria-labelledby="activity-heading">
        <h2 id="activity-heading">Recent Activity</h2>
        <div class="card">
          <div class="card-body">
            <ul class="activity-list">
              <li class="activity-item">
                <i class="bi bi-check-circle text-success" aria-hidden="true"></i>
                <span>All morning routes completed successfully</span>
                <time class="activity-time">2 hours ago</time>
              </li>
              <li class="activity-item">
                <i class="bi bi-person-plus text-info" aria-hidden="true"></i>
                <span>New driver registration pending approval</span>
                <time class="activity-time">3 hours ago</time>
              </li>
              <li class="activity-item">
                <i class="bi bi-tools text-warning" aria-hidden="true"></i>
                <span>Bus 105 scheduled for maintenance</span>
                <time class="activity-time">Yesterday</time>
              </li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <script src="/static/help_system.js"></script>
  <script src="/static/enhanced_help_system.js"></script>
  <script src="/static/autocomplete.js"></script>
  
  {{template "error_prevention_scripts" .}}
  <script nonce="{{.CSPNonce}}">
    // Add help content for quick actions
    document.addEventListener('DOMContentLoaded', function() {
      if (window.helpSystem) {
        window.helpSystem.addHelpContent('quick-actions', {
          title: 'Quick Actions',
          content: 'These buttons provide quick access to common management tasks. Click any action to navigate to that section.'
        });
      }
      
      // Initialize auto-complete for quick search
      initializeQuickSearch();
    });
    
    function initializeQuickSearch() {
      // Bus search auto-complete
      const busSearch = new AutoComplete('quickSearchBus', {
        source: '/api/search-buses',
        minChars: 1,
        template: function(item) {
          return `
            <div class="autocomplete-item-custom">
              <i class="bi ${item.icon || 'bi-bus-front'} autocomplete-item-icon"></i>
              <div class="autocomplete-item-content">
                <div class="autocomplete-item-title">${item.label}</div>
                <div class="autocomplete-item-subtitle">${item.subtitle}</div>
              </div>
            </div>
          `;
        },
        onSelect: function(item) {
          // Navigate to bus details
          window.location.href = `/bus-maintenance/${item.value}`;
        }
      });
      
      // Driver search auto-complete
      const driverSearch = new AutoComplete('quickSearchDriver', {
        source: '/api/search-drivers',
        minChars: 2,
        template: function(item) {
          return `
            <div class="autocomplete-item-custom">
              <i class="bi ${item.icon || 'bi-person-circle'} autocomplete-item-icon"></i>
              <div class="autocomplete-item-content">
                <div class="autocomplete-item-title">${item.label}</div>
                <div class="autocomplete-item-subtitle">${item.subtitle}</div>
              </div>
            </div>
          `;
        },
        onSelect: function(item) {
          // Navigate to driver profile
          window.location.href = `/driver/${item.value}`;
        }
      });
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Dashboard - Fleet Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root {
      --grad-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --grad-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --grad-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --grad-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --grad-danger: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
    }
    
    body {
      background-color: #f8f9fa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    .dashboard-header {
      background: var(--grad-success);
      color: white;
      padding: 1.5rem;
      border-radius: 15px;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);
    }
    
    .dashboard-header .btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.3s ease;
    }
    
    .dashboard-header .btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      color: white;
    }
    
    .enhanced-card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .enhanced-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    
    .enhanced-card .card-header {
      background: linear-gradient(45deg, #f8f9fa, #e9ecef);
      border-bottom: 2px solid #dee2e6;
      padding: 1.25rem;
    }
    
    .enhanced-card .card-header h5 {
      margin: 0;
      font-weight: 600;
      color: #495057;
    }
    
    .info-card {
      border-left: 4px solid #667eea;
      background: linear-gradient(45deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
    }
    
    .metric-card {
      border: none;
      border-radius: 15px;
      transition: all 0.3s ease;
      overflow: hidden;
      position: relative;
    }
    
    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    
    .metric-card .card-body {
      padding: 1.5rem;
    }
    
    .metric-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      opacity: 0.9;
    }
    
    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .metric-label {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }
    
    .bg-gradient-primary { background: var(--grad-primary); }
    .bg-gradient-success { background: var(--grad-success); }
    .bg-gradient-info { background: var(--grad-info); }
    .bg-gradient-warning { background: var(--grad-warning); }
    .bg-gradient-danger { background: var(--grad-danger); }
    
    .quick-action-card {
      border: 2px dashed #dee2e6;
      border-radius: 15px;
      transition: all 0.3s ease;
      cursor: pointer;
      padding: 1.5rem;
      text-align: center;
    }
    
    .quick-action-card:hover {
      border-color: #11998e;
      background-color: rgba(17, 153, 142, 0.05);
      transform: translateY(-3px);
    }
    
    .assignment-info {
      background: linear-gradient(45deg, rgba(17, 153, 142, 0.1), rgba(56, 239, 125, 0.1));
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .assignment-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--grad-success);
      color: white;
    }
    
    .alert-item {
      padding: 1rem;
      border-left: 4px solid #ffc107;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: 0 8px 8px 0;
      transition: all 0.2s ease;
    }
    
    .alert-item:hover {
      border-left-color: #11998e;
      transform: translateX(5px);
    }
    
    .trip-log-item {
      padding: 1rem;
      background: white;
      border-radius: 10px;
      margin-bottom: 0.5rem;
      border-left: 4px solid #17a2b8;
      transition: all 0.2s ease;
    }
    
    .trip-log-item:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .time-display {
      font-size: 1.2rem;
      font-weight: 600;
      color: #495057;
    }
    
    .btn-primary {
      background: var(--grad-success);
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
      background: var(--grad-success);
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    .student-table {
      font-size: 0.9rem;
    }
    
    .student-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
    }
    
    .route-positions {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .position-item {
      padding: 0.5rem;
      margin-bottom: 0.25rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .position-number {
      width: 30px;
      height: 30px;
      background: var(--grad-primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .alert-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    .text-primary {
      color: #11998e !important;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <main class="container-fluid py-4" aria-labelledby="pageTitle">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
          <h1 id="pageTitle" class="fs-3 mb-1">
            <i class="bi bi-bus-front me-2"></i>Driver Dashboard
          </h1>
          <p class="mb-0 opacity-75">Welcome back, {{.User.Username}}! Here's your route overview.</p>
        </div>
        <nav class="btn-group btn-group-sm" role="group" aria-label="Primary actions">
          <a href="/students" class="btn">
            <i class="bi bi-people me-1"></i>Manage Students
          </a>
          <a href="/logout" class="btn">
            <i class="bi bi-box-arrow-right me-1"></i>Logout
          </a>
        </nav>
      </div>
    </header>

    <!-- Route Assignment Status -->
    <div class="row g-4 mb-4">
      <div class="col-12">
        <div class="enhanced-card">
          <div class="card-header">
            <h5><i class="bi bi-clipboard-check me-2"></i>Daily Route Log</h5>
          </div>
          <div class="card-body">
            <form action="/save-log" method="POST">
              <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
              <div class="row mb-3">
                <div class="col-md-3">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control" name="date" value="{{.Date}}" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Period</label>
                  <select class="form-select" name="period">
                    <option value="morning" {{if eq .Period "morning"}}selected{{end}}>Morning Route (AM)</option>
                    <option value="afternoon" {{if eq .Period "afternoon"}}selected{{end}}>Afternoon Route (PM)</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Departure Time</label>
                  <input type="time" class="form-control" name="departure" 
                         value="{{if .DriverLog}}{{.DriverLog.Departure}}{{end}}" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Arrival Time</label>
                  <input type="time" class="form-control" name="arrival" 
                         value="{{if .DriverLog}}{{.DriverLog.Arrival}}{{end}}" required>
                </div>
              </div>

              {{if .Route}}
              <input type="hidden" name="route_id" value="{{.Route.RouteID}}">
              <input type="hidden" name="bus_id" value="{{if .Bus}}{{.Bus.BusID}}{{end}}">
              
              <div class="assignment-info mb-3">
                <div class="row">
                  <div class="col-md-4">
                    <strong><i class="bi bi-bus-front me-1"></i>Bus:</strong> 
                    {{if .Bus}}#{{.Bus.BusID}} - {{.Bus.Model}}{{else}}Not Assigned{{end}}
                  </div>
                  <div class="col-md-4">
                    <strong><i class="bi bi-map me-1"></i>Route:</strong> 
                    {{.Route.RouteName}} ({{.Route.RouteID}})
                  </div>
                  <div class="col-md-4">
                    <strong><i class="bi bi-speedometer2 me-1"></i>Mileage:</strong>
                    <input type="number" class="form-control form-control-sm d-inline-block w-auto" 
                           name="mileage" step="0.1" placeholder="0.0" 
                           value="{{if .DriverLog}}{{.DriverLog.Mileage}}{{end}}" required>
                  </div>
                </div>
              </div>

              <h6 class="mb-3"><i class="bi bi-people me-2"></i>Student Attendance</h6>
              <div class="alert alert-info alert-sm">
                <i class="bi bi-info-circle me-2"></i>
                Students are automatically ordered by their 
                {{if eq .Period "morning"}}pickup{{else}}dropoff{{end}} times for efficient route planning.
              </div>
              <div class="route-positions">
                {{if .Students}}
                <div class="table-responsive">
                  <table class="table student-table">
                    <thead>
                      <tr>
                        <th width="80">Order</th>
                        <th>Student Name</th>
                        <th>Guardian</th>
                        <th>Phone</th>
                        <th width="120">{{if eq .Period "morning"}}Pickup{{else}}Dropoff{{end}} Time</th>
                        <th width="100">Present</th>
                        <th width="150">Actual Time</th>
                      </tr>
                    </thead>
                    <tbody>
                      {{range $index, $student := .Students}}
                      {{$position := $student.PositionNumber}}
                      <tr>
                        <td>
                          <div class="position-number">{{add $index 1}}</div>
                        </td>
                        <td>
                          <strong>{{.Name}}</strong>
                          <br>
                          <small class="text-muted">ID: {{.StudentID}}</small>
                        </td>
                        <td>
                          <small>{{.Guardian}}</small>
                        </td>
                        <td>
                          <small>{{.PhoneNumber}}</small>
                        </td>
                        <td>
                          <strong class="text-primary">
                            {{if eq $.Period "morning"}}
                              {{.PickupTime}}
                            {{else}}
                              {{.DropoffTime}}
                            {{end}}
                          </strong>
                        </td>
                        <td>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   name="present_{{.PositionNumber}}" id="present_{{.PositionNumber}}"
                                   {{if $.DriverLog}}
                                     {{range $.DriverLog.Attendance}}
                                       {{if eq .Position $position}}{{if .Present}}checked{{end}}{{end}}
                                     {{end}}
                                   {{end}}>
                            <label class="form-check-label" for="present_{{.PositionNumber}}">
                              Present
                            </label>
                          </div>
                        </td>
                        <td>
                          <input type="time" class="form-control form-control-sm" 
                                 name="pickup_{{.PositionNumber}}"
                                 placeholder="HH:MM"
                                 {{if $.DriverLog}}
                                   {{range $.DriverLog.Attendance}}
                                     {{if eq .Position $position}}value="{{.PickupTime}}"{{end}}
                                   {{end}}
                                 {{end}}>
                        </td>
                      </tr>
                      {{end}}
                    </tbody>
                  </table>
                </div>
                <div class="mt-2 text-muted">
                  <small><i class="bi bi-info-circle me-1"></i>Total students on route: {{len .Students}}</small>
                  <br>
                  <small><i class="bi bi-clock me-1"></i>Order shows the sequence for {{if eq .Period "morning"}}pickups{{else}}dropoffs{{end}}</small>
                </div>
                {{else}}
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  No students assigned to this route yet. 
                  <a href="/students" class="alert-link">Add students to your route</a>
                </div>
                {{end}}
              </div>

              <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-check-circle me-2"></i>Save Route Log
                </button>
              </div>
              {{else}}
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>No Route Assignment</strong><br>
                You have not been assigned to a route yet. Please contact your manager.
              </div>
              {{end}}
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats Row -->
    {{if .Route}}
    <div class="row g-4 mb-4">
      <div class="col-lg-3 col-md-6">
        <div class="card metric-card bg-gradient-primary text-white">
          <div class="card-body text-center">
            <i class="bi bi-clock-fill metric-icon"></i>
            <div class="metric-value" id="currentTime">--:--</div>
            <div class="metric-label">Current Time</div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card metric-card bg-gradient-success text-white">
          <div class="card-body text-center">
            <i class="bi bi-people-fill metric-icon"></i>
            <div class="metric-value">{{if .Students}}{{len .Students}}{{else}}0{{end}}</div>
            <div class="metric-label">Students on Route</div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card metric-card bg-gradient-info text-white">
          <div class="card-body text-center">
            <i class="bi bi-bus-front metric-icon"></i>
            <div class="metric-value">{{if .Bus}}{{.Bus.BusID}}{{else}}--{{end}}</div>
            <div class="metric-label">Assigned Bus</div>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card metric-card bg-gradient-warning text-white">
          <div class="card-body text-center">
            <i class="bi bi-speedometer2 metric-icon"></i>
            <div class="metric-value">{{if .DriverLog}}{{printf "%.1f" .DriverLog.Mileage}}{{else}}0.0{{end}}</div>
            <div class="metric-label">Today's Miles</div>
          </div>
        </div>
      </div>
    </div>
    {{end}}

    <!-- Recent Logs -->
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="enhanced-card">
          <div class="card-header">
            <h5><i class="bi bi-clock-history me-2"></i>Recent Trip Logs</h5>
          </div>
          <div class="card-body">
            {{if .RecentLogs}}
            {{range .RecentLogs}}
            <div class="trip-log-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{.Date}} - {{.Period}}</strong>
                  <p class="mb-0 text-muted small">
                    <i class="bi bi-clock me-1"></i>{{.Departure}} - {{.Arrival}} • 
                    <i class="bi bi-speedometer2 me-1"></i>{{printf "%.1f" .Mileage}} miles • 
                    <i class="bi bi-people me-1"></i>{{len .Attendance}} students
                  </p>
                </div>
                <span class="badge bg-success">Completed</span>
              </div>
            </div>
            {{end}}
            {{else}}
            <div class="empty-state">
              <i class="bi bi-journal-plus"></i>
              <h6>No Recent Trips</h6>
              <p class="mb-0">Your trip logs will appear here once you start logging</p>
            </div>
            {{end}}
          </div>
        </div>
      </div>

      <!-- Alerts & Quick Actions -->
      <div class="col-lg-4">
        <div class="enhanced-card">
          <div class="card-header">
            <h5><i class="bi bi-lightning-fill me-2"></i>Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <a href="/students" class="text-decoration-none">
                  <div class="quick-action-card">
                    <i class="bi bi-people fs-2 text-success d-block mb-2"></i>
                    <h6 class="fw-semibold">Students</h6>
                    <small class="text-muted">Manage roster</small>
                  </div>
                </a>
              </div>
              <div class="col-6">
                <a href="/driver-dashboard?date={{.Date}}&period=morning" class="text-decoration-none">
                  <div class="quick-action-card">
                    <i class="bi bi-sunrise fs-2 text-warning d-block mb-2"></i>
                    <h6 class="fw-semibold">Morning</h6>
                    <small class="text-muted">AM Route</small>
                  </div>
                </a>
              </div>
              <div class="col-6">
                <a href="/driver-dashboard?date={{.Date}}&period=afternoon" class="text-decoration-none">
                  <div class="quick-action-card">
                    <i class="bi bi-sunset fs-2 text-info d-block mb-2"></i>
                    <h6 class="fw-semibold">Afternoon</h6>
                    <small class="text-muted">PM Route</small>
                  </div>
                </a>
              </div>
              <div class="col-6">
                <a href="/reports" class="text-decoration-none">
                  <div class="quick-action-card">
                    <i class="bi bi-file-text fs-2 text-primary d-block mb-2"></i>
                    <h6 class="fw-semibold">Reports</h6>
                    <small class="text-muted">View history</small>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Update current time
      function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
          hour12: false,
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('currentTime').textContent = timeString;
      }
      updateTime();
      setInterval(updateTime, 1000);

      // Add animation to metric cards
      const metricCards = document.querySelectorAll('.metric-card');
      metricCards.forEach((card, index) => {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
          card.style.transition = 'all 0.5s ease';
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, 100);
        }, index * 150);
      });

      // Add animation to other cards
      const cards = document.querySelectorAll('.enhanced-card');
      cards.forEach((card, index) => {
        setTimeout(() => {
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
          card.style.transition = 'all 0.5s ease';
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          }, 100);
        }, (index + 4) * 200); // Start after metric cards
      });

      // Auto-check present when actual time is entered
      document.querySelectorAll('input[name^="pickup_"]').forEach(function(input) {
        input.addEventListener('change', function() {
          const row = this.closest('tr');
          const checkbox = row.querySelector('input[type="checkbox"]');
          if (this.value && checkbox) {
            checkbox.checked = true;
          }
        });
      });
    });
  </script>
</body>
</html>

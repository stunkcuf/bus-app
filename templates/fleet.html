<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Management - Fleet Management System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/static/modern_theme.css">
  <link rel="stylesheet" href="/static/responsive_tables.css">
  <link rel="stylesheet" href="/static/help_system.css">
  <link rel="stylesheet" href="/static/enhanced_help_system.css">
  <link rel="stylesheet" href="/static/autocomplete.css">
  <style nonce="{{.CSPNonce}}">
    /* Fleet specific styles with purple theme */
    .fleet-header {
      color: white !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      margin-bottom: 2rem;
    }
    
    .fleet-header i {
      color: white !important;
    }
    
    /* Action buttons with gradients */
    .fleet-actions .btn-success {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
    }
    
    .fleet-actions .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }
    
    .fleet-actions .btn-warning {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      border: none;
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);
    }
    
    /* Bus status badges with gradients */
    .bus-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 30px;
      font-weight: 600;
      transition: all var(--transition-base);
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .bus-status.active {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 2px 8px rgba(17, 153, 142, 0.3);
    }
    
    .bus-status.maintenance {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 2px 8px rgba(240, 147, 251, 0.3);
    }
    
    .bus-status.out-of-service {
      background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
    }
    
    .status-indicator.good { 
      background: var(--color-success);
      box-shadow: 0 0 8px rgba(17, 153, 142, 0.5);
    }
    .status-indicator.fair { 
      background: var(--color-warning);
      box-shadow: 0 0 8px rgba(250, 112, 154, 0.5);
    }
    .status-indicator.poor { 
      background: var(--color-danger);
      box-shadow: 0 0 8px rgba(255, 107, 107, 0.5);
    }
    
    /* Fleet table enhancements */
    .fleet-table {
      margin-top: 1.5rem;
    }
    
    .fleet-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .fleet-actions .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="container-fluid page-container">
    <!-- Navigation Component -->
    {{template "navigation" (dict "Navigation" .Navigation "CSPNonce" .CSPNonce "ShowHelpButton" .ShowHelpButton "PageDescription" "Manage your bus fleet and maintenance status")}}
    
    <!-- Page Actions -->
    <header class="page-actions">
      <nav class="page-header-nav">
        <a href="/add-bus-wizard" class="btn btn-primary">
          <i class="bi bi-plus-circle" aria-hidden="true"></i>
          Add New Bus
        </a>
        <a href="/maintenance-wizard" class="btn btn-primary"
           data-help="maintenance-wizard" 
           data-help-title="Maintenance Wizard" 
           data-help-content="Use the step-by-step wizard to log maintenance with smart suggestions and cost tracking.">
          <i class="bi bi-wrench-adjustable" aria-hidden="true"></i>
          Log Maintenance
        </a>
        <a href="/company-fleet" class="btn btn-outline-primary">
          <i class="bi bi-truck" aria-hidden="true"></i>
          Company Vehicles
        </a>
      </nav>
    </header>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
      <!-- Fleet Summary -->
      <section aria-labelledby="summary-heading">
        <h2 id="summary-heading" class="sr-only">Fleet Summary</h2>
        <div class="dashboard-grid">
          <div class="card">
            <div class="card-body text-center">
              <i class="bi bi-check-circle-fill metric-icon" style="color: var(--color-success);" aria-hidden="true"></i>
              <div class="metric-value">{{.ActiveBuses}}</div>
              <div class="metric-label">Active Buses</div>
            </div>
          </div>
          <div class="card">
            <div class="card-body text-center">
              <i class="bi bi-tools metric-icon" style="color: var(--color-warning);" aria-hidden="true"></i>
              <div class="metric-value">{{.MaintenanceBuses}}</div>
              <div class="metric-label">In Maintenance</div>
            </div>
          </div>
          <div class="card">
            <div class="card-body text-center">
              <i class="bi bi-x-circle-fill metric-icon" style="color: var(--color-danger);" aria-hidden="true"></i>
              <div class="metric-value">{{.OutOfServiceBuses}}</div>
              <div class="metric-label">Out of Service</div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Buses Table -->
      <section aria-labelledby="buses-heading">
        <h2 id="buses-heading">All Buses</h2>
        <div class="card">
          <div class="card-body">
            <div class="table-responsive" data-responsive-table>
              <table class="table" aria-label="Bus fleet information">
                <thead>
                  <tr>
                    <th scope="col">Bus ID</th>
                    <th scope="col">Model</th>
                    <th scope="col">Capacity</th>
                    <th scope="col">Status</th>
                    <th scope="col">Oil Status</th>
                    <th scope="col">Tire Status</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{range .Buses}}
                  <tr>
                    <td data-label="Bus ID">
                      <strong>{{.BusID}}</strong>
                    </td>
                    <td data-label="Model">{{.GetModel}}</td>
                    <td data-label="Capacity">{{.GetCapacity}} seats</td>
                    <td data-label="Status">
                      <span class="bus-status {{.Status}}">
                        {{if eq .Status "active"}}
                          <i class="bi bi-check-circle" aria-hidden="true"></i> Active
                        {{else if eq .Status "maintenance"}}
                          <i class="bi bi-tools" aria-hidden="true"></i> Maintenance
                        {{else}}
                          <i class="bi bi-x-circle" aria-hidden="true"></i> Out of Service
                        {{end}}
                      </span>
                    </td>
                    <td data-label="Oil Status">
                      <span class="status-indicator {{.GetOilStatus}}"></span>
                      {{.GetOilStatus}}
                    </td>
                    <td data-label="Tire Status">
                      <span class="status-indicator {{.GetTireStatus}}"></span>
                      {{.GetTireStatus}}
                    </td>
                    <td data-label="Actions">
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="editBus('{{.BusID}}')" 
                                aria-label="Edit {{.BusID}}">
                          <i class="bi bi-pencil" aria-hidden="true"></i>
                          Edit
                        </button>
                        <a href="/bus-maintenance/{{.BusID}}" class="btn btn-sm btn-outline-secondary"
                           aria-label="View maintenance history for {{.BusID}}">
                          <i class="bi bi-wrench" aria-hidden="true"></i>
                          Maintenance
                        </a>
                      </div>
                    </td>
                  </tr>
                  {{end}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <!-- Add Bus Modal -->
  <div class="modal fade" id="addBusModal" tabindex="-1" aria-labelledby="addBusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="addBusModalLabel">Add New Bus</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form action="/add-bus" method="POST" class="accessible-form">
          <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
          <div class="modal-body">
            <div class="form-group">
              <label for="bus_id" class="form-label required">Bus ID</label>
              <input type="text" id="bus_id" name="bus_id" class="form-control" required
                     placeholder="e.g., BUS-001">
              <small class="form-text text-muted">Start typing for suggestions</small>
            </div>
            
            <div class="form-group">
              <label for="model" class="form-label required">Model</label>
              <input type="text" id="model" name="model" class="form-control" required
                     placeholder="e.g., Blue Bird, Thomas Built">
              <small class="form-text text-muted">Start typing for suggestions</small>
            </div>
            
            <div class="form-group">
              <label for="capacity" class="form-label required">Capacity</label>
              <input type="number" id="capacity" name="capacity" class="form-control" min="1" max="100" required
                     placeholder="e.g., 72">
              <small class="form-text text-muted">Number of passenger seats</small>
            </div>
            
            <div class="form-group">
              <label for="status" class="form-label required">Status</label>
              <select id="status" name="status" class="form-control form-select" required>
                <option value="active">Active</option>
                <option value="maintenance">Under Maintenance</option>
                <option value="out-of-service">Out of Service</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Bus</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/responsive_tables.js"></script>
  <script src="/static/help_system.js"></script>
  <script src="/static/accessible_forms.js"></script>
  <script src="/static/enhanced_help_system.js"></script>
  <script src="/static/autocomplete.js"></script>
  
  {{template "error_prevention_scripts" .}}
  
  <script nonce="{{.CSPNonce}}">
    // Initialize responsive tables
    document.addEventListener('DOMContentLoaded', function() {
      const tables = document.querySelectorAll('[data-responsive-table]');
      tables.forEach(table => {
        new ResponsiveTable(table.querySelector('table'));
      });
    });
    
    function editBus(busId) {
      // Implement edit functionality
      alert('Edit functionality for ' + busId + ' coming soon!');
    }
    
    // Initialize auto-complete for Bus ID field
    const busIdAuto = new AutoComplete('bus_id', {
      source: ['BUS-001', 'BUS-002', 'BUS-003', 'BUS-004', 'BUS-005', 
               'MINI-001', 'MINI-002', 'VAN-001', 'VAN-002'],
      minChars: 1,
      placeholder: 'e.g., BUS-001',
      onSelect: function(value) {
        // Auto-format the bus ID
        document.getElementById('bus_id').value = value.toUpperCase();
      }
    });
    
    // Initialize auto-complete for Model field
    const modelAuto = new AutoComplete('model', {
      source: '/api/suggest-models',
      minChars: 0,
      placeholder: 'e.g., Blue Bird Vision',
      template: function(item) {
        return `
          <div class="autocomplete-item-custom">
            <i class="bi ${item.icon || 'bi-bus-front'} autocomplete-item-icon"></i>
            <div class="autocomplete-item-content">
              <div class="autocomplete-item-title">${item.label}</div>
              <div class="autocomplete-item-subtitle">${item.subtitle}</div>
            </div>
          </div>
        `;
      }
    });
    
    // Initialize smart field suggestions for Bus ID
    const smartFields = new SmartFieldSuggestions();
    smartFields.enhance('bus_id', 'busId');
    
    // Add validation for Bus ID format
    document.getElementById('bus_id').addEventListener('blur', function() {
      const value = this.value.trim();
      if (value) {
        const errors = DataValidator.validate(value, [
          { type: 'pattern', value: /^[A-Z0-9-]+$/, message: 'Bus ID must contain only letters, numbers, and hyphens' }
        ]);
        
        if (errors.length > 0) {
          this.classList.add('is-invalid');
          // Show error message
          let feedback = this.nextElementSibling;
          while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
          }
          if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            this.parentNode.insertBefore(feedback, this.nextElementSibling.nextElementSibling);
          }
          feedback.textContent = errors[0];
        } else {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        }
      }
    });
  </script>
</body>
</html>
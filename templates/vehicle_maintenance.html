<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Maintenance - {{if .VehicleNumber}}{{.VehicleNumber}}{{else if .VehicleID}}{{.VehicleID}}{{else}}{{.Unnamed1}}{{end}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background-color: #2c3e50;
            padding-top: 20px;
            transition: all 0.3s;
            z-index: 100;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            color: white;
        }
        .sidebar-menu {
            list-style: none;
            padding: 0;
        }
        .sidebar-menu li {
            padding: 0;
        }
        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: #34495e;
            color: white;
        }
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }
        .main-content.expanded {
            margin-left: 80px;
        }
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        .sidebar.collapsed .sidebar-header h4 {
            display: none;
        }
        .toggle-btn {
            position: absolute;
            right: -15px;
            top: 60px;
            background: #2c3e50;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            z-index: 101;
        }
        .status-chip {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-operational {
            background-color: #d4edda;
            color: #155724;
        }
        .status-maintenance {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-repair {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .maintenance-item {
            border-bottom: 1px solid #dee2e6;
            padding: 15px 0;
        }
        .maintenance-item:last-child {
            border-bottom: none;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .toggle-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <button class="toggle-btn" onclick="toggleSidebar()">
            <i class="bi bi-chevron-left" id="toggle-icon"></i>
        </button>
        <div class="sidebar-header">
            <h4><span class="sidebar-text">Transit System</span></h4>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/dashboard">
                    <i class="bi bi-speedometer2"></i>
                    <span class="sidebar-text">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="/fleet" class="active">
                    <i class="bi bi-bus-front"></i>
                    <span class="sidebar-text">Fleet Management</span>
                </a>
            </li>
            <li>
                <a href="/routes">
                    <i class="bi bi-map"></i>
                    <span class="sidebar-text">Routes</span>
                </a>
            </li>
            <li>
                <a href="/real-time">
                    <i class="bi bi-geo-alt"></i>
                    <span class="sidebar-text">Real-Time Tracking</span>
                </a>
            </li>
            <li>
                <a href="/reports">
                    <i class="bi bi-file-earmark-text"></i>
                    <span class="sidebar-text">Reports</span>
                </a>
            </li>
            <li>
                <a href="/settings">
                    <i class="bi bi-gear"></i>
                    <span class="sidebar-text">Settings</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container-fluid">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="/fleet">Fleet Management</a></li>
                            <li class="breadcrumb-item active">Vehicle Maintenance</li>
                        </ol>
                    </nav>
                    <h2>Vehicle Maintenance</h2>
                </div>
            </div>

            <!-- Vehicle Info -->
            <div class="info-card">
                <div class="row">
                    <div class="col-md-8">
                        <h3>{{if .IsBus}}Bus #{{if .VehicleNumber}}{{.VehicleNumber}}{{else if .VehicleID}}{{.VehicleID}}{{else}}{{.Unnamed1}}{{end}}{{else}}{{if .VehicleNumber}}{{.VehicleNumber}}{{else if .VehicleID}}{{.VehicleID}}{{else}}{{.Unnamed1}}{{end}}{{end}}</h3>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Vehicle ID:</strong> {{if .VehicleID}}{{.VehicleID}}{{else if .VehicleNumber}}{{.VehicleNumber}}{{else}}{{.Unnamed1}}{{end}}</p>
                                <p><strong>Vehicle Number:</strong> {{if .VehicleNumber}}{{.VehicleNumber}}{{else}}N/A{{end}}</p>
                                <p><strong>Model:</strong> {{.Model}}</p>
                                <p><strong>Year:</strong> {{.Year}}</p>
                                <p><strong>License:</strong> {{if .License}}{{.License}}{{else}}N/A{{end}}</p>
                                <p><strong>Serial Number:</strong> {{if .SerialNumber}}{{.SerialNumber}}{{else}}N/A{{end}}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Status:</strong> <span class="status-chip status-{{.Status}}">{{.Status}}</span></p>
                                <p><strong>Oil Status:</strong> {{.OilStatus}}</p>
                                <p><strong>Tire Status:</strong> {{.TireStatus}}</p>
                                <p><strong>Tire Size:</strong> {{if .TireSize}}{{.TireSize}}{{else}}N/A{{end}}</p>
                                <p><strong>Base:</strong> {{if .Base}}{{.Base}}{{else}}N/A{{end}}</p>
                                <p><strong>Service Interval:</strong> {{if .ServiceInterval}}{{.ServiceInterval}} days{{else}}N/A{{end}}</p>
                            </div>
                        </div>
                        {{if .MaintenanceNotes}}
                        <div class="row mt-3">
                            <div class="col-12">
                                <p><strong>Maintenance Notes:</strong> {{.MaintenanceNotes}}</p>
                            </div>
                        </div>
                        {{end}}
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#scheduleMaintenanceModal">
                            <i class="bi bi-calendar-plus"></i> Schedule Maintenance
                        </button>
                        <br>
                        <button class="btn btn-outline-secondary" onclick="generateReport()">
                            <i class="bi bi-file-earmark-pdf"></i> Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Maintenance History -->
            <div class="card">
                <div class="card-header">
                    <h4>Maintenance History</h4>
                </div>
                <div class="card-body">
                    {{if .MaintenanceHistory}}
                        {{range .MaintenanceHistory}}
                        <div class="maintenance-item">
                            <div class="row">
                                <div class="col-md-2">
                                    <strong>{{.Date}}</strong>
                                </div>
                                <div class="col-md-3">
                                    <span class="badge bg-{{if eq .Type "Routine"}}info{{else if eq .Type "Repair"}}warning{{else}}secondary{{end}}">{{.Type}}</span>
                                </div>
                                <div class="col-md-5">
                                    {{.Description}}
                                </div>
                                <div class="col-md-2 text-end">
                                    ${{.Cost}}
                                </div>
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <p class="text-muted">No maintenance records found.</p>
                    {{end}}
                </div>
            </div>

            <!-- Active Issues -->
            <div class="card mt-4">
                <div class="card-header">
                    <h4>Active Issues</h4>
                </div>
                <div class="card-body">
                    {{if .ActiveIssues}}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Issue</th>
                                        <th>Severity</th>
                                        <th>Reported</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .ActiveIssues}}
                                    <tr>
                                        <td>{{.Description}}</td>
                                        <td>
                                            <span class="badge bg-{{if eq .Severity "High"}}danger{{else if eq .Severity "Medium"}}warning{{else}}info{{end}}">
                                                {{.Severity}}
                                            </span>
                                        </td>
                                        <td>{{.ReportedDate}}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="resolveIssue('{{.ID}}')">
                                                Resolve
                                            </button>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    {{else}}
                        <p class="text-muted">No active issues reported.</p>
                    {{end}}
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Maintenance Modal -->
    <div class="modal fade" id="scheduleMaintenanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Schedule Maintenance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form action="/schedule-maintenance" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="vehicle_id" value="{{if .VehicleID}}{{.VehicleID}}{{else if .VehicleNumber}}{{.VehicleNumber}}{{else}}{{.Unnamed1}}{{end}}">
                        <input type="hidden" name="vehicle_number" value="{{.VehicleNumber}}">
                        <input type="hidden" name="unnamed_1" value="{{.Unnamed1}}">
                        
                        <div class="mb-3">
                            <label class="form-label">Maintenance Type</label>
                            <select class="form-select" name="type" required>
                                <option value="">Select type...</option>
                                <option value="Routine">Routine Service</option>
                                <option value="Repair">Repair</option>
                                <option value="Inspection">Inspection</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Estimated Cost</label>
                            <input type="number" class="form-control" name="cost" step="0.01">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Schedule</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleIcon = document.getElementById('toggle-icon');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('bi-chevron-left');
                toggleIcon.classList.add('bi-chevron-right');
            } else {
                toggleIcon.classList.remove('bi-chevron-right');
                toggleIcon.classList.add('bi-chevron-left');
            }
        }

        function resolveIssue(issueId) {
            if (confirm('Mark this issue as resolved?')) {
                // Send request to resolve issue
                fetch(`/resolve-issue/${issueId}`, {
                    method: 'POST'
                }).then(() => {
                    location.reload();
                });
            }
        }

        function generateReport() {
            const vehicleId = '{{if .VehicleID}}{{.VehicleID}}{{else if .VehicleNumber}}{{.VehicleNumber}}{{else}}{{.Unnamed1}}{{end}}';
            window.open(`/maintenance-report/${vehicleId}`, '_blank');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS Tracking - Fleet Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/static/modern_theme.css">
    <!-- Dark Theme Text Colors -->
    <link rel="stylesheet" href="/static/dark_theme_text.css">
  
  <style nonce="{{.CSPNonce}}">
    body {
      background: #0f0c29;
      background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #map {
      height: 600px;
      width: 100%;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      color: white;
    }
    
    .vehicle-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .vehicle-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }
    
    .vehicle-card.active {
      background: rgba(102, 126, 234, 0.2);
      border-color: #667eea;
    }
    
    .status-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .status-active {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.5);
    }
    
    .status-idle {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.5);
    }
    
    .status-offline {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.5);
    }
    
    .info-window {
      color: #333;
      font-size: 14px;
      padding: 10px;
    }
    
    .info-window h6 {
      margin-bottom: 10px;
      color: #667eea;
    }
    
    .controls-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 5;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    .legend {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .legend-marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    /* Fix text colors */
    .text-muted {
      color: rgba(255, 255, 255, 0.6) !important;
    }
    
    .form-control {
      color: white !important;
    }
    
    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.5) !important;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg" style="background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
    <div class="container-fluid">
      <a class="navbar-brand" href="/" style="color: white; text-decoration: none; font-weight: 600;">
        <i class="bi bi-geo-alt-fill"></i> GPS Tracking
      </a>
      <button class="btn btn-outline-light btn-sm" onclick="window.history.back()">
        <i class="bi bi-arrow-left"></i> Back
      </button>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Vehicle List -->
      <div class="col-md-3">
        <div class="glass-card">
          <h5 class="mb-3">
            <i class="bi bi-truck"></i> Fleet Vehicles
          </h5>
          
          <div class="mb-3">
            <input type="text" class="form-control" id="vehicleSearch" 
                   placeholder="Search vehicles..." style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white;">
          </div>
          
          <div id="vehicleList">
            {{range .Vehicles}}
            <div class="vehicle-card" data-vehicle-id="{{.VehicleID}}" onclick="selectVehicle('{{.VehicleID}}')">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{.VehicleID}}</strong>
                  {{if .Model.Valid}}
                  <br><small>{{.Model.String}}</small>
                  {{end}}
                </div>
                <div>
                  {{if index $.Locations .VehicleID}}
                    {{with index $.Locations .VehicleID}}
                      {{if eq .Status "active"}}
                        <span class="status-badge status-active">Active</span>
                      {{else if eq .Status "idle"}}
                        <span class="status-badge status-idle">Idle</span>
                      {{else}}
                        <span class="status-badge status-offline">Offline</span>
                      {{end}}
                    {{end}}
                  {{else}}
                    <span class="status-badge status-offline">No GPS</span>
                  {{end}}
                </div>
              </div>
              
              {{if index $.Locations .VehicleID}}
                {{with index $.Locations .VehicleID}}
                <small class="text-muted d-block mt-2">
                  <i class="bi bi-speedometer2"></i> {{printf "%.1f" .Speed}} km/h
                  {{if .DriverID}}
                  <br><i class="bi bi-person"></i> {{.DriverID}}
                  {{end}}
                  <br><i class="bi bi-clock"></i> {{.Timestamp.Format "3:04 PM"}}
                </small>
                {{end}}
              {{end}}
            </div>
            {{end}}
          </div>
        </div>
      </div>
      
      <!-- Map -->
      <div class="col-md-9">
        <div class="glass-card p-0" style="position: relative;">
          {{if .MapAPIKey}}
          <div id="map"></div>
          {{else}}
          <div id="map" style="display: flex; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.3);">
            <div class="text-center text-white p-4">
              <i class="bi bi-geo-alt-fill" style="font-size: 4rem; opacity: 0.5;"></i>
              <h4 class="mt-3">GPS Tracking Unavailable</h4>
              <p class="mb-0">Google Maps API key not configured.</p>
              <p class="text-muted">Contact your administrator to set up GPS tracking.</p>
            </div>
          </div>
          {{end}}
          
          <!-- Controls Panel -->
          <div class="controls-panel">
            <h6 class="mb-3">Map Controls</h6>
            
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
              <label class="form-check-label" for="autoRefresh">
                Auto Refresh (5s)
              </label>
            </div>
            
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="showRoutes" checked>
              <label class="form-check-label" for="showRoutes">
                Show Routes
              </label>
            </div>
            
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="showGeofences">
              <label class="form-check-label" for="showGeofences">
                Show Geofences
              </label>
            </div>
            
            <button class="btn btn-sm btn-primary w-100 mt-3" onclick="centerOnAllVehicles()">
              <i class="bi bi-arrows-fullscreen"></i> Fit All Vehicles
            </button>
          </div>
        </div>
        
        <!-- Legend -->
        <div class="glass-card mt-3">
          <h6 class="mb-3">Legend</h6>
          <div class="row">
            <div class="col-md-3">
              <div class="legend-item">
                <div class="legend-marker" style="background: #22c55e;"></div>
                <span>Active (Moving)</span>
              </div>
            </div>
            <div class="col-md-3">
              <div class="legend-item">
                <div class="legend-marker" style="background: #fbbf24;"></div>
                <span>Idle (Stopped)</span>
              </div>
            </div>
            <div class="col-md-3">
              <div class="legend-item">
                <div class="legend-marker" style="background: #ef4444;"></div>
                <span>Offline</span>
              </div>
            </div>
            <div class="col-md-3">
              <div class="legend-item">
                <div class="legend-marker" style="background: #6b7280;"></div>
                <span>No GPS Signal</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script nonce="{{.CSPNonce}}">
    let map;
    let markers = {};
    let selectedVehicle = null;
    let ws = null;
    let autoRefreshInterval = null;
    
    // Initialize map
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.7128, lng: -74.0060 }, // Default to NYC
        zoom: 12,
        styles: [
          {
            "featureType": "all",
            "elementType": "geometry",
            "stylers": [{ "color": "#242f3e" }]
          },
          {
            "featureType": "all",
            "elementType": "labels.text.stroke",
            "stylers": [{ "lightness": -80 }]
          },
          {
            "featureType": "administrative",
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#746855" }]
          },
          {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [{ "color": "#38414e" }]
          },
          {
            "featureType": "road",
            "elementType": "geometry.stroke",
            "stylers": [{ "color": "#212a37" }]
          },
          {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [{ "color": "#17263c" }]
          }
        ]
      });
      
      // Add initial markers
      {{range $vehicleID, $location := .Locations}}
      addOrUpdateMarker({
        vehicle_id: "{{$vehicleID}}",
        latitude: {{$location.Latitude}},
        longitude: {{$location.Longitude}},
        speed: {{$location.Speed}},
        heading: {{$location.Heading}},
        status: "{{$location.Status}}",
        driver_id: "{{$location.DriverID}}",
        timestamp: "{{$location.Timestamp.Format "2006-01-02 15:04:05"}}"
      });
      {{end}}
      
      // Center on all vehicles
      centerOnAllVehicles();
      
      // Setup WebSocket connection
      setupWebSocket();
      
      // Setup auto refresh
      setupAutoRefresh();
    }
    
    // Add or update vehicle marker
    function addOrUpdateMarker(location) {
      const position = { lat: location.latitude, lng: location.longitude };
      
      if (markers[location.vehicle_id]) {
        // Update existing marker
        markers[location.vehicle_id].setPosition(position);
        markers[location.vehicle_id].locationData = location;
        
        // Update rotation for heading
        if (location.heading) {
          const icon = markers[location.vehicle_id].getIcon();
          icon.rotation = location.heading;
          markers[location.vehicle_id].setIcon(icon);
        }
      } else {
        // Create new marker
        const marker = new google.maps.Marker({
          position: position,
          map: map,
          title: location.vehicle_id,
          icon: {
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 6,
            fillColor: getMarkerColor(location.status),
            fillOpacity: 0.8,
            strokeColor: 'white',
            strokeWeight: 2,
            rotation: location.heading || 0
          }
        });
        
        marker.locationData = location;
        
        // Add info window
        const infoWindow = new google.maps.InfoWindow({
          content: getInfoWindowContent(location)
        });
        
        marker.addListener('click', () => {
          infoWindow.setContent(getInfoWindowContent(location));
          infoWindow.open(map, marker);
        });
        
        markers[location.vehicle_id] = marker;
      }
      
      // Update vehicle card
      updateVehicleCard(location);
    }
    
    // Get marker color based on status
    function getMarkerColor(status) {
      switch(status) {
        case 'active': return '#22c55e';
        case 'idle': return '#fbbf24';
        case 'offline': return '#ef4444';
        default: return '#6b7280';
      }
    }
    
    // Get info window content
    function getInfoWindowContent(location) {
      return `
        <div class="info-window">
          <h6>${location.vehicle_id}</h6>
          <table>
            <tr><td><strong>Status:</strong></td><td>${location.status}</td></tr>
            <tr><td><strong>Speed:</strong></td><td>${location.speed.toFixed(1)} km/h</td></tr>
            ${location.driver_id ? `<tr><td><strong>Driver:</strong></td><td>${location.driver_id}</td></tr>` : ''}
            <tr><td><strong>Last Update:</strong></td><td>${new Date(location.timestamp).toLocaleTimeString()}</td></tr>
            ${location.battery_level ? `<tr><td><strong>Battery:</strong></td><td>${location.battery_level}%</td></tr>` : ''}
          </table>
        </div>
      `;
    }
    
    // Update vehicle card in sidebar
    function updateVehicleCard(location) {
      const card = document.querySelector(`[data-vehicle-id="${location.vehicle_id}"]`);
      if (!card) return;
      
      // Update status badge
      const statusBadge = card.querySelector('.status-badge');
      if (statusBadge) {
        statusBadge.className = 'status-badge status-' + location.status;
        statusBadge.textContent = location.status.charAt(0).toUpperCase() + location.status.slice(1);
      }
      
      // Update speed and time
      const details = card.querySelector('.text-muted');
      if (details) {
        details.innerHTML = `
          <i class="bi bi-speedometer2"></i> ${location.speed.toFixed(1)} km/h
          ${location.driver_id ? `<br><i class="bi bi-person"></i> ${location.driver_id}` : ''}
          <br><i class="bi bi-clock"></i> ${new Date(location.timestamp).toLocaleTimeString()}
        `;
      }
    }
    
    // Select vehicle
    function selectVehicle(vehicleId) {
      // Update UI
      document.querySelectorAll('.vehicle-card').forEach(card => {
        card.classList.remove('active');
      });
      document.querySelector(`[data-vehicle-id="${vehicleId}"]`).classList.add('active');
      
      selectedVehicle = vehicleId;
      
      // Center map on vehicle
      if (markers[vehicleId]) {
        map.setCenter(markers[vehicleId].getPosition());
        map.setZoom(16);
      }
    }
    
    // Center map on all vehicles
    function centerOnAllVehicles() {
      const bounds = new google.maps.LatLngBounds();
      let hasMarkers = false;
      
      for (const vehicleId in markers) {
        bounds.extend(markers[vehicleId].getPosition());
        hasMarkers = true;
      }
      
      if (hasMarkers) {
        map.fitBounds(bounds);
      }
    }
    
    // Setup WebSocket connection
    function setupWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws/gps`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log('WebSocket connected');
      };
      
      ws.onmessage = (event) => {
        const location = JSON.parse(event.data);
        addOrUpdateMarker(location);
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
      
      ws.onclose = () => {
        console.log('WebSocket disconnected');
        // Reconnect after 5 seconds
        setTimeout(setupWebSocket, 5000);
      };
    }
    
    // Setup auto refresh
    function setupAutoRefresh() {
      const checkbox = document.getElementById('autoRefresh');
      
      const refresh = () => {
        if (checkbox.checked) {
          // Refresh all vehicle positions
          fetch('/api/gps/vehicles')
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                data.locations.forEach(location => {
                  addOrUpdateMarker(location);
                });
              }
            })
            .catch(error => console.error('Refresh error:', error));
        }
      };
      
      // Initial setup
      if (checkbox.checked) {
        autoRefreshInterval = setInterval(refresh, 5000);
      }
      
      // Handle checkbox change
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          autoRefreshInterval = setInterval(refresh, 5000);
        } else {
          clearInterval(autoRefreshInterval);
        }
      });
    }
    
    // Search vehicles
    document.getElementById('vehicleSearch').addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase();
      document.querySelectorAll('.vehicle-card').forEach(card => {
        const vehicleId = card.dataset.vehicleId.toLowerCase();
        card.style.display = vehicleId.includes(search) ? 'block' : 'none';
      });
    });
  </script>
  
  <!-- Google Maps API -->
  {{if .MapAPIKey}}
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{.MapAPIKey}}&callback=initMap">
  </script>
  {{end}}
</body>
</html>
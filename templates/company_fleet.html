<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Company Fleet Overview</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --active-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --maintenance-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    body {
      background: #f5f7fa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    .fleet-header {
      background: var(--primary-gradient);
      color: #fff;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    #searchInput {
      border-radius: 30px;
      padding: 0.5rem 1rem;
    }

    .table-container {
      max-height: 70vh;
      overflow-y: auto;
    }

    .table thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 5;
    }

    .status-light {
      border: none;
      background: transparent;
      padding: 2px 8px;
    }

    .oil-status-good .bi-circle-fill { color: #28a745; }
    .oil-status-needs_service .bi-circle-fill { color: #ffc107; }
    .oil-status-overdue .bi-circle-fill { color: #dc3545; }
    .tire-status-good .bi-circle-fill { color: #28a745; }
    .tire-status-worn .bi-circle-fill { color: #ffc107; }
    .tire-status-replace .bi-circle-fill { color: #dc3545; }
    .vehicle-status-active .bi-circle-fill { color: #28a745; }
    .vehicle-status-maintenance .bi-circle-fill { color: #ffc107; }
    .vehicle-status-out_of_service .bi-circle-fill { color: #dc3545; }
  </style>
</head>
<body>
<main class="container-fluid py-4" aria-labelledby="pageTitle">
  <header class="fleet-header d-flex justify-content-between align-items-center flex-wrap">
    <h2 id="pageTitle" class="mb-3 mb-md-0">
      <i class="bi bi-truck me-2"></i>Company Fleet Overview
    </h2>
    <div class="d-flex align-items-center gap-3">
      <div class="input-group" style="width: 300px;">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="search" id="searchInput" class="form-control" placeholder="Search by ID, model, license..." />
      </div>
      <nav class="d-flex gap-2">
        <a href="/manager-dashboard" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left me-1"></i>Back
        </a>
        <a href="/logout" class="btn btn-outline-danger btn-sm">
          <i class="bi bi-box-arrow-right me-1"></i>Logout
        </a>
      </nav>
    </div>
  </header>

  <section>
    <div class="card shadow-sm">
      <div class="card-header bg-white border-0">
        <h5 class="fw-semibold mb-0"><i class="bi bi-list-ul me-2"></i>All Vehicles (<span>{{len .Vehicles}}</span>)</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-container">
          <table class="table table-hover align-middle mb-0" id="fleetTable">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Model / Description</th>
                <th>Year</th>
                <th>Tire Size</th>
                <th>License</th>
                <th>Oil</th>
                <th>Tires</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {{range .Vehicles}}
              <tr>
                <td>{{.VehicleID}}</td>
                <td>{{if .Model}}{{.Model}}{{else}}{{.Description}}{{end}}</td>
                <td>{{.Year}}</td>
                <td>{{if .TireSize}}{{.TireSize}}{{else}}<span class="text-muted">--</span>{{end}}</td>
                <td>{{.License}}</td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm status-light oil-status-{{.OilStatus}} dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="bi bi-circle-fill"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="oil" data-value="good"><i class="bi bi-circle-fill text-success"></i> Good</a></li>
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="oil" data-value="needs_service"><i class="bi bi-circle-fill text-warning"></i> Needs Service</a></li>
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="oil" data-value="overdue"><i class="bi bi-circle-fill text-danger"></i> Overdue</a></li>
                    </ul>
                  </div>
                </td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm status-light tire-status-{{.TireStatus}} dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="bi bi-circle-fill"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="tire" data-value="good"><i class="bi bi-circle-fill text-success"></i> Good</a></li>
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="tire" data-value="worn"><i class="bi bi-circle-fill text-warning"></i> Worn</a></li>
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="tire" data-value="replace"><i class="bi bi-circle-fill text-danger"></i> Replace</a></li>
                    </ul>
                  </div>
                </td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm status-light vehicle-status-{{.Status}} dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="bi bi-circle-fill"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="status" data-value="active"><i class="bi bi-circle-fill text-success"></i> Active</a></li>
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="status" data-value="maintenance"><i class="bi bi-circle-fill text-warning"></i> Maintenance</a></li>
                      <li><a href="#" class="dropdown-item update-status" data-id="{{.VehicleID}}" data-type="status" data-value="out_of_service"><i class="bi bi-circle-fill text-danger"></i> Out of Service</a></li>
                    </ul>
                  </div>
                </td>
              </tr>
              {{end}}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById('searchInput');
    const tableRows = Array.from(document.querySelectorAll('#fleetTable tbody tr'));

    function normalize(s) {
      return s.toString().toLowerCase();
    }

    function filterRows() {
      const query = normalize(searchInput.value);
      tableRows.forEach(row => {
        const rowText = normalize(row.textContent);
        row.style.display = rowText.includes(query) ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', filterRows);

    document.querySelectorAll('.update-status').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const vehicleId = this.dataset.id;
        const type = this.dataset.type;
        const value = this.dataset.value;
        updateStatus(vehicleId, type, value);
      });
    });
  });

  function updateStatus(vehicleId, statusType, newStatus) {
    const formData = new FormData();
    formData.append('vehicle_id', vehicleId);
    formData.append('status_type', statusType);
    formData.append('new_status', newStatus);

    fetch('/update-vehicle-status', {
      method: 'POST',
      body: formData
    })
    .then(res => {
      if (res.ok) {
        setTimeout(() => window.location.reload(), 500);
      } else {
        alert('Update failed. Please try again.');
        window.location.reload();
      }
    })
    .catch(() => {
      alert('Network error. Please try again.');
      window.location.reload();
    });
  }
</script>
</body>
</html>

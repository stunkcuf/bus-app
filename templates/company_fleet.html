<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Company Fleet Overview</title>
  <!-- Bootstrap CSS & Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
  />
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --active-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --maintenance-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    body {
      background: #f5f7fa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    /* Header */
    .fleet-header {
      background: var(--primary-gradient);
      color: #fff;
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    .fleet-header h2 {
      font-weight: 700;
      margin: 0;
    }

    /* Search */
    #searchInput {
      border-radius: 30px;
      padding: 0.5rem 1rem;
    }

    /* Table Styling */
    .table-container {
      max-height: 70vh;
      overflow-y: auto;
    }
    .table thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 5;
    }
    .status-badge {
      font-size: 0.775rem;
    }
    .bg-active {
      background: var(--active-gradient) !important;
      color: #fff !important;
    }
    .bg-maintenance {
      background: var(--maintenance-gradient) !important;
      color: #fff !important;
    }

    /* Traffic Light Status Indicators */
    .status-light {
      border: none;
      background: transparent;
      padding: 2px 8px;
    }
    
    .status-light:focus {
      box-shadow: none;
    }

    /* Oil Status Colors */
    .oil-status-good .bi-circle-fill { color: #28a745; }
    .oil-status-needs_service .bi-circle-fill { color: #ffc107; }
    .oil-status-overdue .bi-circle-fill { color: #dc3545; }
    .oil-status- .bi-circle-fill { color: #6c757d; }

    /* Tire Status Colors */
    .tire-status-good .bi-circle-fill { color: #28a745; }
    .tire-status-worn .bi-circle-fill { color: #ffc107; }
    .tire-status-replace .bi-circle-fill { color: #dc3545; }
    .tire-status- .bi-circle-fill { color: #6c757d; }

    /* Vehicle Status Colors */
    .vehicle-status-active .bi-circle-fill { color: #28a745; }
    .vehicle-status-maintenance .bi-circle-fill { color: #ffc107; }
    .vehicle-status-out_of_service .bi-circle-fill { color: #dc3545; }
    .vehicle-status- .bi-circle-fill { color: #6c757d; }
  </style>
</head>
<body>
  <main class="container-fluid py-4" aria-labelledby="pageTitle">
    <!-- Header -->
    <header class="fleet-header d-flex justify-content-between align-items-center flex-wrap">
      <h2 id="pageTitle" class="mb-3 mb-md-0">
        <i class="bi bi-truck me-2" aria-hidden="true"></i>Company Fleet Overview
      </h2>
      <div class="d-flex align-items-center gap-3">
        <div class="input-group" style="width: 300px;">
          <span class="input-group-text" id="searchLabel" aria-label="Search vehicles">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="search"
            id="searchInput"
            class="form-control"
            placeholder="Search by ID, model, license..."
            aria-describedby="searchLabel"
          />
        </div>
        <nav class="d-flex gap-2" aria-label="Navigation">
          <a href="/manager-dashboard" class="btn btn-outline-light btn-sm">
            <i class="bi bi-arrow-left me-1" aria-hidden="true"></i>Back to Dashboard
          </a>
          <a href="/logout" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-box-arrow-right me-1" aria-hidden="true"></i>Logout
          </a>
        </nav>
      </div>
    </header>

    <!-- Fleet Table -->
    <section aria-label="Fleet list">
      <div class="card shadow-sm">
        <div class="card-header bg-white border-0">
          <h5 class="fw-semibold mb-0"><i class="bi bi-list-ul me-2"></i>All Vehicles (<span>{{len .Vehicles}}</span>)</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-container">
            <table class="table table-hover align-middle mb-0" id="fleetTable">
              <thead class="table-light">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Model / Description</th>
                  <th scope="col">Year</th>
                  <th scope="col">Tire Size</th>
                  <th scope="col">License</th>
                  <th scope="col">Oil</th>
                  <th scope="col">Tires</th>
                  <th scope="col">Status</th>
                </tr>
              </thead>
              <tbody>
                {{range .Vehicles}}
                <tr>
                  <td>{{.VehicleID}}</td>
                  <td>{{if .Model}}{{.Model}}{{else}}{{.Description}}{{end}}</td>
                  <td>{{.Year}}</td>
                  <td>{{if .TireSize}}{{.TireSize}}{{else}}<span class="text-muted">--</span>{{end}}</td>
                  <td>{{.License}}</td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-sm status-light oil-status-{{.OilStatus}} dropdown-toggle" type="button" data-bs-toggle="dropdown" onclick="setCurrentVehicle('{{.VehicleID}}', 'oil')">
                        <i class="bi bi-circle-fill"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'oil', 'good')"><i class="bi bi-circle-fill text-success"></i> Good</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'oil', 'needs_service')"><i class="bi bi-circle-fill text-warning"></i> Needs Service</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'oil', 'overdue')"><i class="bi bi-circle-fill text-danger"></i> Overdue</a></li>
                      </ul>
                    </div>
                  </td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-sm status-light tire-status-{{.TireStatus}} dropdown-toggle" type="button" data-bs-toggle="dropdown" onclick="setCurrentVehicle('{{.VehicleID}}', 'tire')">
                        <i class="bi bi-circle-fill"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'tire', 'good')"><i class="bi bi-circle-fill text-success"></i> Good</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'tire', 'worn')"><i class="bi bi-circle-fill text-warning"></i> Worn</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'tire', 'replace')"><i class="bi bi-circle-fill text-danger"></i> Replace</a></li>
                      </ul>
                    </div>
                  </td>
                  <td>
                    <div class="dropdown">
                      <button class="btn btn-sm status-light vehicle-status-{{.Status}} dropdown-toggle" type="button" data-bs-toggle="dropdown" onclick="setCurrentVehicle('{{.VehicleID}}', 'status')">
                        <i class="bi bi-circle-fill"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'status', 'active')"><i class="bi bi-circle-fill text-success"></i> Active</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'status', 'maintenance')"><i class="bi bi-circle-fill text-warning"></i> Maintenance</a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateStatus('{{.VehicleID}}', 'status', 'out_of_service')"><i class="bi bi-circle-fill text-danger"></i> Out of Service</a></li>
                      </ul>
                    </div>
                  </td>
                </tr>
                {{end}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Clientâ€‘side, accessible table filtering
    (function () {
      const searchInput = document.getElementById('searchInput');
      const tableRows = Array.from(document.querySelectorAll('#fleetTable tbody tr'));

      const normalize = (s) => s.toString().toLowerCase();

      function filterRows() {
        const query = normalize(searchInput.value);
        tableRows.forEach((row) => {
          const rowText = normalize(row.textContent);
          const match = rowText.includes(query);
          row.style.display = match ? '' : 'none';
        });
      }

      searchInput.addEventListener('input', filterRows);
    })();

    // Status Update Functionality
    let currentVehicleId = '';
    let currentStatusType = '';

    function setCurrentVehicle(vehicleId, statusType) {
      currentVehicleId = vehicleId;
      currentStatusType = statusType;
    }

    function updateStatus(vehicleId, statusType, newStatus) {
      console.log(`Updating ${statusType} status for vehicle ${vehicleId} to ${newStatus}`);
      
      // Close all dropdowns
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.classList.remove('show');
      });

      // Update the UI immediately for better responsiveness
      updateUIStatus(vehicleId, statusType, newStatus);

      // Send update to server
      const formData = new FormData();
      formData.append('vehicle_id', vehicleId);
      formData.append('status_type', statusType);
      formData.append('new_status', newStatus);

      fetch('/update-vehicle-status', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          console.log(`Successfully updated ${statusType} status for vehicle ${vehicleId} to ${newStatus}`);
          // Optionally refresh after a short delay to confirm server state
          setTimeout(() => window.location.reload(), 1000);
        } else {
          console.error('Failed to update status');
          alert('Failed to update status. Please try again.');
          // Revert UI change on error
          window.location.reload();
        }
      })
      .catch(error => {
        console.error('Error updating status:', error);
        alert('Error updating status. Please check your connection and try again.');
        window.location.reload();
      });
    }

    function updateUIStatus(vehicleId, statusType, newStatus) {
      // Find the button for this vehicle and status type
      const button = document.querySelector(`button[onclick*="${vehicleId}"][onclick*="${statusType}"]`);
      if (button) {
        // Update button class
        button.className = button.className.replace(new RegExp(`${statusType}-status-\\w+`), `${statusType}-status-${newStatus}`);
        
        // Update the circle color based on the new status
        const circle = button.querySelector('.bi-circle-fill');
        if (circle) {
          // Remove existing color classes
          circle.classList.remove('text-success', 'text-warning', 'text-danger', 'text-secondary');
          
          // Add appropriate color class based on status
          switch(newStatus) {
            case 'good':
            case 'active':
              circle.classList.add('text-success');
              break;
            case 'needs_service':
            case 'worn':
            case 'maintenance':
              circle.classList.add('text-warning');
              break;
            case 'overdue':
            case 'replace':
            case 'out_of_service':
              circle.classList.add('text-danger');
              break;
            default:
              circle.classList.add('text-secondary');
          }
        }
      }
    }

    
  </script>
</body>
</html>